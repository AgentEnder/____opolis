import{R as y}from"./chunk-NnsilhFv.js";const w=n=>{let a;const t=new Set,e=(d,p)=>{const m=typeof d=="function"?d(a):d;if(!Object.is(m,a)){const g=a;a=p??(typeof m!="object"||m===null)?m:Object.assign({},a,m),t.forEach(f=>f(a,g))}},o=()=>a,i={setState:e,getState:o,getInitialState:()=>c,subscribe:d=>(t.add(d),()=>t.delete(d))},c=a=n(e,o,i);return i},H=(n=>n?w(n):w),R=n=>n;function P(n,a=R){const t=y.useSyncExternalStore(n.subscribe,y.useCallback(()=>a(n.getState()),[n,a]),y.useCallback(()=>a(n.getInitialState()),[n,a]));return y.useDebugValue(t),t}const v=n=>{const a=H(n),t=e=>P(a,e);return Object.assign(t,a),t},T=(n=>n?v(n):v),$=n=>(a,t,e)=>{const o=e.subscribe;return e.subscribe=((l,i,c)=>{let d=l;if(i){const p=c?.equalityFn||Object.is;let m=l(e.getState());d=g=>{const f=l(g);if(!p(m,f)){const D=m;i(m=f,D)}},c?.fireImmediately&&i(m,m)}return o(d)}),n(a,t,e)},_=$;function j(n,a){let t;try{t=n()}catch{return}return{getItem:o=>{var s;const l=c=>c===null?null:JSON.parse(c,void 0),i=(s=t.getItem(o))!=null?s:null;return i instanceof Promise?i.then(l):l(i)},setItem:(o,s)=>t.setItem(o,JSON.stringify(s,void 0)),removeItem:o=>t.removeItem(o)}}const b=n=>a=>{try{const t=n(a);return t instanceof Promise?t:{then(e){return b(e)(t)},catch(e){return this}}}catch(t){return{then(e){return this},catch(e){return b(e)(t)}}}},F=(n,a)=>(t,e,o)=>{let s={storage:j(()=>localStorage),partialize:r=>r,version:0,merge:(r,S)=>({...S,...r}),...a},l=!1;const i=new Set,c=new Set;let d=s.storage;if(!d)return n((...r)=>{console.warn(`[zustand persist middleware] Unable to update item '${s.name}', the given storage is currently unavailable.`),t(...r)},e,o);const p=()=>{const r=s.partialize({...e()});return d.setItem(s.name,{state:r,version:s.version})},m=o.setState;o.setState=(r,S)=>(m(r,S),p());const g=n((...r)=>(t(...r),p()),e,o);o.getInitialState=()=>g;let f;const D=()=>{var r,S;if(!d)return;l=!1,i.forEach(u=>{var h;return u((h=e())!=null?h:g)});const k=((S=s.onRehydrateStorage)==null?void 0:S.call(s,(r=e())!=null?r:g))||void 0;return b(d.getItem.bind(d))(s.name).then(u=>{if(u)if(typeof u.version=="number"&&u.version!==s.version){if(s.migrate){const h=s.migrate(u.state,u.version);return h instanceof Promise?h.then(C=>[!0,C]):[!0,h]}console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,u.state];return[!1,void 0]}).then(u=>{var h;const[C,O]=u;if(f=s.merge(O,(h=e())!=null?h:g),t(f,!0),C)return p()}).then(()=>{k?.(f,void 0),f=e(),l=!0,c.forEach(u=>u(f))}).catch(u=>{k?.(void 0,u)})};return o.persist={setOptions:r=>{s={...s,...r},r.storage&&(d=r.storage)},clearStorage:()=>{d?.removeItem(s.name)},getOptions:()=>s,rehydrate:()=>D(),hasHydrated:()=>l,onHydrate:r=>(i.add(r),()=>{i.delete(r)}),onFinishHydration:r=>(c.add(r),()=>{c.delete(r)})},s.skipHydration||D(),f||g},J=F;function I(n,a){if(!a)return n;const t=n.cells.map(e=>e.map(o=>({...o,customMetadata:a})));return{...n,cells:t}}function x(n){const a=n.baseCards.map(e=>{const o=e.customMetadata;return I(e,o)}),t=n.expansions.map(e=>({...e,cards:e.cards.map(o=>{const s=o.customMetadata;return I(o,s)})}));return{...n,baseCards:a,expansions:t}}function N(n){const a=t=>t.some(e=>e.customMetadata!==void 0);return a(n.baseCards)||n.expansions.some(t=>a(t.cards))}function M(n){const a=t=>t.map(e=>{const{customMetadata:o,...s}=e;return s});return{...n,baseCards:a(n.baseCards),expansions:n.expansions.map(t=>({...t,cards:a(t.cards)}))}}const B=()=>`custom-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,U=T()(J((n,a)=>({customDecks:[],selectedCustomDeck:null,addDeck:t=>{const e=B(),o={...t,id:e,type:"custom",isCustom:!0,metadata:{...t.metadata,created:new Date,modified:new Date}};return n(s=>({customDecks:[...s.customDecks,o]})),e},updateDeck:(t,e)=>{n(o=>({customDecks:o.customDecks.map(s=>s.id===t?{...s,...e,metadata:{...s.metadata,...e.metadata,modified:new Date}}:s)}))},deleteDeck:t=>{n(e=>({customDecks:e.customDecks.filter(o=>o.id!==t),selectedCustomDeck:e.selectedCustomDeck?.id===t?null:e.selectedCustomDeck}))},selectDeck:t=>{n({selectedCustomDeck:t})},exportDeck:t=>{const e=a().getDeckById(t);if(!e)throw new Error("Deck not found");const o={...e,exportVersion:"1.0",exportedAt:new Date().toISOString()};return JSON.stringify(o,null,2)},importDeck:async t=>{try{const e=JSON.parse(t);if(!e.name||!e.baseCards||!Array.isArray(e.baseCards))throw new Error("Invalid deck format: missing required fields");if(e.baseCards.length===0)throw new Error("Deck must contain at least one card");const o=a().customDecks.map(c=>c.name.toLowerCase());let s=e.name,l=1;for(;o.includes(s.toLowerCase());)s=`${e.name} (${l})`,l++;let i={name:s,description:e.description||"Imported custom deck",type:"custom",isCustom:!0,baseCards:e.baseCards,expansions:e.expansions||[],zoneTypes:e.zoneTypes||[{id:"residential",name:"Residential",color:"#60a5fa",description:"Housing areas"},{id:"commercial",name:"Commercial",color:"#f59e0b",description:"Business districts"},{id:"industrial",name:"Industrial",color:"#6b7280",description:"Manufacturing zones"},{id:"park",name:"Park",color:"#34d399",description:"Green spaces"}],theme:e.theme||{primaryColor:"#8b5cf6",secondaryColor:"#7c3aed"},metadata:{author:e.metadata?.author||"Unknown",created:new Date,modified:new Date,version:e.metadata?.version||"1.0"},customScoringConditions:e.customScoringConditions||[],metadataSchema:e.metadataSchema||void 0};if(N(i)){const c=x(i);i=M(c)}a().addDeck(i)}catch(e){throw e instanceof SyntaxError?new Error("Invalid JSON format"):e}},duplicateDeck:t=>{const e=a().getDeckById(t);if(!e)throw new Error("Deck not found");const o=a().customDecks.map(c=>c.name.toLowerCase());let s=`${e.name} (Copy)`,l=1;for(;o.includes(s.toLowerCase());)s=`${e.name} (Copy ${l})`,l++;const i={...e,name:s,metadata:{...e.metadata,created:new Date,modified:new Date}};a().addDeck(i)},getDeckById:t=>{const e=a().customDecks.find(o=>o.id===t);if(e&&!e.customScoringConditions&&(e.customScoringConditions=[]),e&&N(e)){const o=x(e),s=M(o);return a().updateDeck(t,s),s}return e}}),{name:"custom-decks-storage",version:1})),E={transform:{scale:1,offsetX:0,offsetY:0},isDragging:!1,dragStart:{x:0,y:0},isMobile:!1,controlsExpanded:!1,isPlacing:!1,placementPos:{x:0,y:0},showNotification:!1,notificationMessage:"",notificationType:"info",highlightedTiles:null,highlightedCondition:null,highlightedClusterType:null,showRoadNetworks:!1},q=T()(_((n,a)=>({...E,setTransform:t=>n(e=>({transform:{...e.transform,...t}})),setDragging:(t,e)=>n(()=>({isDragging:t,dragStart:e||a().dragStart})),setMobile:t=>n(()=>({isMobile:t})),setControlsExpanded:t=>n(()=>({controlsExpanded:t})),setPlacing:(t,e)=>n(o=>({isPlacing:t,placementPos:e||o.placementPos})),showNotificationMessage:(t,e="info")=>n(()=>({showNotification:!0,notificationMessage:t,notificationType:e})),hideNotification:()=>n(()=>({showNotification:!1,notificationMessage:""})),resetUI:()=>n(()=>E),setHighlightedTiles:t=>n(()=>({highlightedTiles:t})),setHighlightedCondition:t=>n(()=>({highlightedCondition:t})),setHighlightedClusterType:t=>n(()=>({highlightedClusterType:t})),setShowRoadNetworks:t=>n(()=>({showRoadNetworks:t}))})));export{q as a,T as c,U as u};
