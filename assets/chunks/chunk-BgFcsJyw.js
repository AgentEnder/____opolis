const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/chunk-Dszta4ZM.js","assets/chunks/chunk-NnsilhFv.js","assets/chunks/chunk-BIVpqUci.js","assets/static/vike-react-cc21853d.BcWtY8Ol.css","assets/static/layouts_style-b34a8e57.c_1FbwL7.css","assets/static/layouts_tailwind-00e65532.BZqQmOMT.css"])))=>i.map(i=>d[i]);
import{j as G,r as F,d as _e,R as Ot}from"./chunk-NnsilhFv.js";import{a as pn}from"./chunk-yrsSxuPR.js";import{_ as ke}from"./chunk-IUYf3yx-.js";const y=(e,t=[])=>({type:e,roads:t}),N={HORIZONTAL:[[3,1]],VERTICAL:[[0,2]],L_TOP_RIGHT:[[0,1]],L_RIGHT_BOTTOM:[[1,2]],L_BOTTOM_LEFT:[[2,3]],L_LEFT_TOP:[[3,0]]},hn={id:"sprawopolis",name:"Sprawopolis",description:"The original urban planning card game",type:"preset",isCustom:!1,zoneTypes:[{id:"residential",name:"Residential",color:"#60a5fa",description:"Housing areas"},{id:"commercial",name:"Commercial",color:"#f59e0b",description:"Business districts"},{id:"industrial",name:"Industrial",color:"#6b7280",description:"Manufacturing zones"},{id:"park",name:"Park",color:"#34d399",description:"Green spaces"}],theme:{primaryColor:"#3b82f6",secondaryColor:"#1e40af"},baseCards:[{id:"spr-001",name:"Residential Block",count:3,cells:[[y("residential"),y("residential")],[y("residential"),y("park")]],scoringConditionId:"spr-001-residential-block"},{id:"spr-002",name:"Suburb",count:2,cells:[[y("residential",N.HORIZONTAL),y("residential",N.HORIZONTAL)],[y("park"),y("residential")]],scoringConditionId:"spr-002-suburb"},{id:"spr-003",name:"Shopping District",count:2,cells:[[y("commercial"),y("commercial")],[y("commercial"),y("residential")]],scoringConditionId:"spr-003-shopping-district"},{id:"spr-004",name:"Main Street",count:3,cells:[[y("commercial",N.VERTICAL),y("park")],[y("commercial",N.VERTICAL),y("commercial")]],scoringConditionId:"spr-004-main-street"},{id:"spr-005",name:"Factory District",count:2,cells:[[y("industrial"),y("industrial")],[y("industrial"),y("park")]],scoringConditionId:"spr-005-factory-district"},{id:"spr-006",name:"Warehouse",count:2,cells:[[y("industrial",N.L_TOP_RIGHT),y("commercial")],[y("park"),y("industrial")]],scoringConditionId:"spr-006-warehouse"},{id:"spr-007",name:"Mixed Use",count:4,cells:[[y("commercial"),y("residential")],[y("park"),y("industrial")]],scoringConditionId:"spr-007-mixed-use"},{id:"spr-008",name:"Intersection",count:3,cells:[[y("park",N.L_LEFT_TOP),y("commercial",N.L_TOP_RIGHT)],[y("residential",N.L_BOTTOM_LEFT),y("industrial",N.L_RIGHT_BOTTOM)]],scoringConditionId:"spr-008-intersection"}],expansions:[{id:"spr-exp-1",name:"Sprawopolis: Beaches",description:"Adds coastal development cards",cards:[{id:"spr-beach-001",name:"Beachfront",count:2,cells:[[y("park"),y("park")],[y("residential"),y("commercial")]],scoringConditionId:"spr-beach-001-beachfront"},{id:"spr-beach-002",name:"Pier",count:1,cells:[[y("commercial",N.HORIZONTAL),y("commercial",N.HORIZONTAL)],[y("park"),y("park")]],scoringConditionId:"spr-beach-002-pier"}]}]},mn={id:"agropolis",name:"Agropolis",description:"Rural farming and countryside development",type:"preset",isCustom:!1,zoneTypes:[{id:"fields",name:"Fields",color:"#84cc16",description:"Farmland and crops"},{id:"livestock",name:"Livestock",color:"#a78bfa",description:"Animal farming"},{id:"orchards",name:"Orchards",color:"#34d399",description:"Fruit trees"},{id:"buildings",name:"Buildings",color:"#f59e0b",description:"Farm buildings"}],theme:{primaryColor:"#22c55e",secondaryColor:"#15803d"},baseCards:[{id:"agr-001",name:"Farmland",count:4,cells:[[y("park"),y("park")],[y("park"),y("residential")]],scoringConditionId:"agr-001-farmland"},{id:"agr-002",name:"Barn Complex",count:3,cells:[[y("industrial"),y("park")],[y("park"),y("park")]],scoringConditionId:"agr-002-barn-complex"},{id:"agr-003",name:"Country Store",count:2,cells:[[y("commercial",N.L_TOP_RIGHT),y("residential")],[y("park"),y("park")]],scoringConditionId:"agr-003-country-store"},{id:"agr-004",name:"Rural Road",count:4,cells:[[y("park",N.HORIZONTAL),y("park",N.HORIZONTAL)],[y("residential"),y("park")]],scoringConditionId:"agr-004-rural-road"}],expansions:[]},yn={id:"casinopolis",name:"Casinopolis",description:"Glitzy casino and entertainment district",type:"preset",isCustom:!1,zoneTypes:[{id:"casino",name:"Casino",color:"#dc2626",description:"Gaming floors"},{id:"hotel",name:"Hotel",color:"#7c3aed",description:"Accommodation"},{id:"entertainment",name:"Entertainment",color:"#06b6d4",description:"Shows and venues"},{id:"dining",name:"Dining",color:"#f59e0b",description:"Restaurants and bars"}],theme:{primaryColor:"#f59e0b",secondaryColor:"#d97706"},baseCards:[{id:"cas-001",name:"Casino Floor",count:3,cells:[[y("commercial"),y("commercial")],[y("commercial"),y("commercial")]]},{id:"cas-002",name:"Hotel Tower",count:2,cells:[[y("residential"),y("residential")],[y("commercial"),y("park")]]},{id:"cas-003",name:"Entertainment District",count:3,cells:[[y("commercial",N.VERTICAL),y("park")],[y("commercial",N.VERTICAL),y("residential")]]},{id:"cas-004",name:"Service Area",count:2,cells:[[y("industrial"),y("commercial")],[y("park"),y("residential")]]}],expansions:[]},gn=[hn,mn,yn],Bt=2,Xt=2;function Yt(e,t,n){return{x:e.x+n,y:e.y+t}}function $(e){const t=new Map;return e.forEach((n,s)=>{for(let o=0;o<Xt;o++)for(let r=0;r<Bt;r++)if(n.cells&&n.cells[o]&&n.cells[o][r]){const i=n.cells[o][r],{x:a,y:c}=Yt(n,o,r),l=`${a},${c}`;t.set(l,{cardId:n.id,x:a,y:c,...i,cardIndex:s})}}),Array.from(t.values())}function W(e){const t=$(e),n=new Set,s=[];function o(i,a){return[{x:i-1,y:a},{x:i+1,y:a},{x:i,y:a-1},{x:i,y:a+1}]}function r(i,a){const c={type:a,tiles:[],size:0},l=[i];for(;l.length>0;){const p=l.pop(),d=`${p.x},${p.y}`;if(n.has(d))continue;n.add(d),c.tiles.push(p);const f=o(p.x,p.y);for(const h of f){const m=t.find(T=>T.x===h.x&&T.y===h.y),v=`${h.x},${h.y}`;m&&m.type===a&&!n.has(v)&&l.push(m)}}return c.size=c.tiles.length,c}for(const i of t){const a=`${i.x},${i.y}`;if(!n.has(a)){const c=r(i,i.type);s.push(c)}}return s}function Ee(e){const t=new Map;e.forEach((s,o)=>{for(let r=0;r<Xt;r++)for(let i=0;i<Bt;i++)if(s.cells&&s.cells[r]&&s.cells[r][i]){const{x:a,y:c}=Yt(s,r,i),l=`${a},${c}`;t.set(l,o)}});const n=[];return e.forEach((s,o)=>{for(let r=0;r<Xt;r++)for(let i=0;i<Bt;i++){const a=s.cells?.[r]?.[i];if(a&&a.roads&&a.roads.length>0){const{x:c,y:l}=Yt(s,r,i),p=`${c},${l}`;if(t.get(p)===o)for(const d of a.roads)n.push({cardId:s.id,cellRow:r,cellCol:i,x:c,y:l,segment:d})}}}),n}function vn(e,t){const n=Math.abs(e.x-t.x),s=Math.abs(e.y-t.y);if(!(n===1&&s===0||n===0&&s===1))return!1;let o,r;n===1&&s===0?e.x<t.x?(o=1,r=3):(o=3,r=1):e.y<t.y?(o=2,r=0):(o=0,r=2);const i=e.segment[0]===o||e.segment[1]===o,a=t.segment[0]===r||t.segment[1]===r;return i&&a}function Y(e){const t=Ee(e),n=new Set,s=[];function o(i){return`${i.cardId}-${i.cellRow}-${i.cellCol}-${i.segment[0]}-${i.segment[1]}`}function r(i){const a={segments:[],size:0},c=[i];for(;c.length>0;){const l=c.pop(),p=o(l);if(!n.has(p)){n.add(p),a.segments.push(l);for(const d of t){const f=o(d);!n.has(f)&&vn(l,d)&&c.push(d)}}}return a.size=a.segments.length,a}for(const i of t){const a=o(i);if(!n.has(a)){const c=r(i);s.push(c)}}return s}function bn(e){const t=W(e),n=Y(e),s=new Set;for(const p of e)for(const d of p.cells)for(const f of d)s.add(f.type);const o={},r={},i={};for(const p of s)o[p]=0,r[p]=null,i[p]=[];for(const p of t)i[p.type].push(p);for(const p of s){const d=i[p];if(d.length>0){const f=d.reduce((h,m)=>m.size>h.size?m:h);r[p]=f,o[p]=f.size}}const a=-n.length,l=Object.values(o).reduce((p,d)=>p+d,0)+a;return{clusterScores:o,roadPenalty:a,baseScore:l,largestClusters:r,roadNetworks:n}}function le(e,t=[]){const{clusterScores:n,roadPenalty:s,baseScore:o,largestClusters:r,roadNetworks:i}=bn(e),a=t.map(d=>{const f=d.evaluate(e),h=d.evaluateWithDetails?d.evaluateWithDetails(e):void 0;return{condition:d,points:f,details:h}}),c=a.reduce((d,f)=>d+f.points,0),l=o+c,p=t.reduce((d,f)=>d+(f.targetContribution||0),0);return{clusterScores:n,roadPenalty:s,baseScore:o,conditionScores:a,conditionTotal:c,totalScore:l,targetScore:p,largestClusters:r,roadNetworks:i}}const $e={"spr-001-residential-block":{id:"spr-001-residential-block",name:"Block Party",description:"+1 point for each residential tile in your largest residential group",targetContribution:6,evaluate:e=>{const n=W(e).filter(o=>o.type==="residential");return n.length===0?0:n.reduce((o,r)=>r.size>o.size?r:o).size},evaluateWithDetails:e=>{const n=W(e).filter(o=>o.type==="residential");if(n.length===0)return{points:0,relevantTiles:[],description:"No residential areas"};const s=n.reduce((o,r)=>r.size>o.size?r:o);return{points:s.size,relevantTiles:s.tiles.map(o=>({x:o.x,y:o.y})),description:`Largest residential block: ${s.size} tiles`}}},"spr-002-suburb":{id:"spr-002-suburb",name:"Suburban Sprawl",description:"+2 points for each residential tile connected by roads",targetContribution:8,evaluate:e=>$(e).filter(s=>s.type==="residential"&&s.roads&&s.roads.length>0).length*2,evaluateWithDetails:e=>{const n=$(e).filter(s=>s.type==="residential"&&s.roads&&s.roads.length>0);return{points:n.length*2,relevantTiles:n.map(s=>({x:s.x,y:s.y})),description:`${n.length} residential tiles with roads × 2`}}},"spr-003-shopping-district":{id:"spr-003-shopping-district",name:"Shopping Spree",description:"+3 points for each group of 3+ commercial tiles",targetContribution:9,evaluate:e=>W(e).filter(s=>s.type==="commercial"&&s.size>=3).length*3,evaluateWithDetails:e=>{const n=W(e).filter(o=>o.type==="commercial"&&o.size>=3),s=[];for(const o of n)for(const r of o.tiles)s.push({x:r.x,y:r.y});return{points:n.length*3,relevantTiles:s,description:`${n.length} commercial groups (3+ tiles) × 3`}}},"spr-004-main-street":{id:"spr-004-main-street",name:"Main Street",description:"+1 point for each commercial tile with roads",targetContribution:5,evaluate:e=>$(e).filter(n=>n.type==="commercial"&&n.roads&&n.roads.length>0).length,evaluateWithDetails:e=>{const n=$(e).filter(s=>s.type==="commercial"&&s.roads&&s.roads.length>0);return{points:n.length,relevantTiles:n.map(s=>({x:s.x,y:s.y})),description:`${n.length} commercial tiles with roads`}}},"spr-005-factory-district":{id:"spr-005-factory-district",name:"Industrial Complex",description:"+4 points for each group of 3+ industrial tiles",targetContribution:8,evaluate:e=>W(e).filter(s=>s.type==="industrial"&&s.size>=3).length*4,evaluateWithDetails:e=>{const n=W(e).filter(o=>o.type==="industrial"&&o.size>=3),s=[];for(const o of n)for(const r of o.tiles)s.push({x:r.x,y:r.y});return{points:n.length*4,relevantTiles:s,description:`${n.length} industrial groups (3+ tiles) × 4`}}},"spr-006-warehouse":{id:"spr-006-warehouse",name:"Logistics Hub",description:"+2 points for each industrial tile adjacent to commercial",targetContribution:6,evaluate:e=>{const t=$(e),n=t.filter(r=>r.type==="industrial"),s=t.filter(r=>r.type==="commercial");let o=0;for(const r of n)s.some(a=>{const c=Math.abs(r.x-a.x),l=Math.abs(r.y-a.y);return c===1&&l===0||c===0&&l===1})&&(o+=2);return o},evaluateWithDetails:e=>{const t=$(e),n=t.filter(i=>i.type==="industrial"),s=t.filter(i=>i.type==="commercial"),o=[];let r=0;for(const i of n)s.some(c=>{const l=Math.abs(i.x-c.x),p=Math.abs(i.y-c.y);return l===1&&p===0||l===0&&p===1})&&(r++,o.push({x:i.x,y:i.y}));return{points:r*2,relevantTiles:o,description:`${r} industrial tiles adjacent to commercial × 2`}}},"spr-007-mixed-use":{id:"spr-007-mixed-use",name:"Mixed Development",description:"+5 points if you have at least 2 tiles of each zone type",targetContribution:5,evaluate:e=>{const t=$(e),n={};for(const r of t)n[r.type]=(n[r.type]||0)+1;return["residential","commercial","industrial","park"].every(r=>(n[r]||0)>=2)?5:0},evaluateWithDetails:e=>{const t=$(e),n={};for(const r of t)n[r.type]=(n[r.type]||0)+1;const s=["residential","commercial","industrial","park"],o=s.every(r=>(n[r]||0)>=2);return{points:o?5:0,relevantTiles:o?t.map(r=>({x:r.x,y:r.y})):[],description:o?"Mixed development achieved (2+ of each zone)":`Need 2+ of each zone: ${s.map(r=>`${r}:${n[r]||0}`).join(", ")}`}}},"spr-008-intersection":{id:"spr-008-intersection",name:"Traffic Flow",description:"-1 point per road network (reduced penalty)",targetContribution:3,evaluate:e=>{const t=Y(e);return Math.max(0,3-t.length)},evaluateWithDetails:e=>{const t=Y(e),n=Math.max(0,3-t.length),s=[];for(const o of t)for(const r of o.segments)s.some(i=>i.x===r.x&&i.y===r.y)||s.push({x:r.x,y:r.y});return{points:n,relevantTiles:s,description:`${t.length} road networks: ${n} points`}}},"agr-001-farmland":{id:"agr-001-farmland",name:"Green Acres",description:"+2 points for each park tile in your largest park group",targetContribution:8,evaluate:e=>{const n=W(e).filter(o=>o.type==="park");return n.length===0?0:n.reduce((o,r)=>r.size>o.size?r:o).size*2},evaluateWithDetails:e=>{const n=W(e).filter(o=>o.type==="park");if(n.length===0)return{points:0,relevantTiles:[],description:"No park areas"};const s=n.reduce((o,r)=>r.size>o.size?r:o);return{points:s.size*2,relevantTiles:s.tiles.map(o=>({x:o.x,y:o.y})),description:`Largest park group: ${s.size} tiles × 2`}}},"agr-002-barn-complex":{id:"agr-002-barn-complex",name:"Farm Buildings",description:"+3 points for each industrial tile adjacent to 2+ park tiles",targetContribution:9,evaluate:e=>{const t=$(e),n=t.filter(r=>r.type==="industrial"),s=t.filter(r=>r.type==="park");let o=0;for(const r of n)s.filter(a=>{const c=Math.abs(r.x-a.x),l=Math.abs(r.y-a.y);return c===1&&l===0||c===0&&l===1}).length>=2&&(o+=3);return o},evaluateWithDetails:e=>{const t=$(e),n=t.filter(i=>i.type==="industrial"),s=t.filter(i=>i.type==="park"),o=[];let r=0;for(const i of n)s.filter(c=>{const l=Math.abs(i.x-c.x),p=Math.abs(i.y-c.y);return l===1&&p===0||l===0&&p===1}).length>=2&&(r++,o.push({x:i.x,y:i.y}));return{points:r*3,relevantTiles:o,description:`${r} industrial tiles adjacent to 2+ parks × 3`}}},"agr-003-country-store":{id:"agr-003-country-store",name:"Country Commerce",description:"+4 points for each commercial tile with roads adjacent to residential",targetContribution:8,evaluate:e=>{const t=$(e),n=t.filter(r=>r.type==="commercial"&&r.roads&&r.roads.length>0),s=t.filter(r=>r.type==="residential");let o=0;for(const r of n)s.some(a=>{const c=Math.abs(r.x-a.x),l=Math.abs(r.y-a.y);return c===1&&l===0||c===0&&l===1})&&(o+=4);return o},evaluateWithDetails:e=>{const t=$(e),n=t.filter(i=>i.type==="commercial"&&i.roads&&i.roads.length>0),s=t.filter(i=>i.type==="residential"),o=[];let r=0;for(const i of n)s.some(c=>{const l=Math.abs(i.x-c.x),p=Math.abs(i.y-c.y);return l===1&&p===0||l===0&&p===1})&&(r++,o.push({x:i.x,y:i.y}));return{points:r*4,relevantTiles:o,description:`${r} commercial tiles with roads adjacent to residential × 4`}}},"agr-004-rural-road":{id:"agr-004-rural-road",name:"Rural Connections",description:"+1 point for each park tile connected by roads",targetContribution:6,evaluate:e=>$(e).filter(s=>s.type==="park"&&s.roads&&s.roads.length>0).length,evaluateWithDetails:e=>{const n=$(e).filter(s=>s.type==="park"&&s.roads&&s.roads.length>0);return{points:n.length,relevantTiles:n.map(s=>({x:s.x,y:s.y})),description:`${n.length} park tiles with roads`}}},"spr-beach-001-beachfront":{id:"spr-beach-001-beachfront",name:"Coastal Paradise",description:"+3 points for each park tile adjacent to residential or commercial",targetContribution:9,evaluate:e=>{const t=$(e),n=t.filter(r=>r.type==="park"),s=t.filter(r=>r.type==="residential"||r.type==="commercial");let o=0;for(const r of n)s.some(a=>{const c=Math.abs(r.x-a.x),l=Math.abs(r.y-a.y);return c===1&&l===0||c===0&&l===1})&&(o+=3);return o},evaluateWithDetails:e=>{const t=$(e),n=t.filter(i=>i.type==="park"),s=t.filter(i=>i.type==="residential"||i.type==="commercial"),o=[];let r=0;for(const i of n)s.some(c=>{const l=Math.abs(i.x-c.x),p=Math.abs(i.y-c.y);return l===1&&p===0||l===0&&p===1})&&(r++,o.push({x:i.x,y:i.y}));return{points:r*3,relevantTiles:o,description:`${r} park tiles adjacent to buildings × 3`}}},"spr-beach-002-pier":{id:"spr-beach-002-pier",name:"Waterfront Commerce",description:"+5 points for each commercial tile in a group of 4+ commercial tiles",targetContribution:10,evaluate:e=>W(e).filter(s=>s.type==="commercial"&&s.size>=4).reduce((s,o)=>s+o.size*5,0),evaluateWithDetails:e=>{const n=W(e).filter(r=>r.type==="commercial"&&r.size>=4),s=[];let o=0;for(const r of n){o+=r.size*5;for(const i of r.tiles)s.push({x:i.x,y:i.y})}return{points:o,relevantTiles:s,description:n.length>0?`${n.map(r=>r.size).join("+")} commercial tiles in large groups × 5`:"No commercial groups of 4+"}}},"residential-groups":{id:"residential-groups",name:"Residential Groups",description:"+1 point per residential area (instead of just the largest)",targetContribution:8,evaluate:e=>W(e).filter(s=>s.type==="residential").reduce((s,o)=>s+o.size,0),evaluateWithDetails:e=>{const n=W(e).filter(r=>r.type==="residential"),s=[];for(const r of n)for(const i of r.tiles)s.push({x:i.x,y:i.y});const o=n.reduce((r,i)=>r+i.size,0);return{points:o,relevantTiles:s,description:`${n.length} residential area(s) = ${o} points`}}},"residential-near-parks":{id:"residential-near-parks",name:"Suburban Living",description:"+1 point for each residential tile adjacent to a park tile",targetContribution:6,evaluate:e=>{const t=$(e),n=t.filter(r=>r.type==="residential"),s=t.filter(r=>r.type==="park");let o=0;for(const r of n)s.some(a=>{const c=Math.abs(r.x-a.x),l=Math.abs(r.y-a.y);return c===1&&l===0||c===0&&l===1})&&(o+=1);return o},evaluateWithDetails:e=>{const t=$(e),n=t.filter(i=>i.type==="residential"),s=t.filter(i=>i.type==="park"),o=[];let r=0;for(const i of n){const a=s.filter(c=>{const l=Math.abs(i.x-c.x),p=Math.abs(i.y-c.y);return l===1&&p===0||l===0&&p===1});if(a.length>0){r+=1,o.push({x:i.x,y:i.y});for(const c of a)o.some(l=>l.x===c.x&&l.y===c.y)||o.push({x:c.x,y:c.y})}}return{points:r,relevantTiles:o,description:`${r} residential tiles adjacent to parks`}}},"commercial-corners":{id:"commercial-corners",name:"Corner Shops",description:"+3 points for each commercial tile at the corner of a 2x2 square",targetContribution:9,evaluate:e=>{const t=$(e),n=t.filter(o=>o.type==="commercial");let s=0;for(const o of n){const r=[[-1,-1],[0,-1],[-1,0],[0,0]];for(const[i,a]of r){const l=[{x:o.x+i,y:o.y+a},{x:o.x+i+1,y:o.y+a},{x:o.x+i,y:o.y+a+1},{x:o.x+i+1,y:o.y+a+1}].map(d=>t.find(f=>f.x===d.x&&f.y===d.y));if(l.every(d=>d!==void 0)&&l.filter(f=>f.type==="commercial").length===1&&l.some(f=>f.x===o.x&&f.y===o.y)){s+=3;break}}}return s},evaluateWithDetails:e=>{const t=$(e),n=t.filter(r=>r.type==="commercial"),s=[];let o=0;for(const r of n){const i=[[-1,-1],[0,-1],[-1,0],[0,0]];for(const[a,c]of i){const l=[{x:r.x+a,y:r.y+c},{x:r.x+a+1,y:r.y+c},{x:r.x+a,y:r.y+c+1},{x:r.x+a+1,y:r.y+c+1}],p=l.map(f=>t.find(h=>h.x===f.x&&h.y===f.y));if(p.every(f=>f!==void 0)&&p.filter(h=>h.type==="commercial").length===1&&p.some(h=>h.x===r.x&&h.y===r.y)){o+=3;for(const h of l)s.some(m=>m.x===h.x&&m.y===h.y)||s.push({x:h.x,y:h.y});break}}}return{points:o,relevantTiles:s,description:`${o/3} commercial corner shop(s) in 2x2 squares = ${o} points`}}},"industrial-edges":{id:"industrial-edges",name:"Industrial District",description:"+2 points for each industrial tile on the edge of your city",targetContribution:8,evaluate:e=>{const t=$(e),n=t.filter(c=>c.type==="industrial");if(t.length===0)return 0;const s=Math.min(...t.map(c=>c.x)),o=Math.max(...t.map(c=>c.x)),r=Math.min(...t.map(c=>c.y)),i=Math.max(...t.map(c=>c.y));let a=0;for(const c of n)(c.x===s||c.x===o||c.y===r||c.y===i)&&(a+=2);return a},evaluateWithDetails:e=>{const t=$(e),n=t.filter(l=>l.type==="industrial"),s=[];if(t.length===0)return{points:0,relevantTiles:[],description:"No tiles on board = 0 points"};const o=Math.min(...t.map(l=>l.x)),r=Math.max(...t.map(l=>l.x)),i=Math.min(...t.map(l=>l.y)),a=Math.max(...t.map(l=>l.y));let c=0;for(const l of n)(l.x===o||l.x===r||l.y===i||l.y===a)&&(c+=2,s.push({x:l.x,y:l.y}));return{points:c,relevantTiles:s,description:`${c/2} industrial tiles on city edges = ${c} points`}}},"long-roads":{id:"long-roads",name:"Highway System",description:"+2 points for each road network with 4+ segments (instead of -1 penalty)",targetContribution:6,evaluate:e=>Y(e).filter(s=>s.size>=4).length*2,evaluateWithDetails:e=>{const n=Y(e).filter(r=>r.size>=4),s=[];for(const r of n)for(const i of r.segments)s.some(a=>a.x===i.x&&a.y===i.y)||s.push({x:i.x,y:i.y});const o=n.length*2;return{points:o,relevantTiles:s,description:`${n.length} long road(s) with 4+ segments = ${o} points`}}},"road-loops":{id:"road-loops",name:"Circular Routes",description:"+5 points for each road network that forms a complete loop",targetContribution:10,evaluate:e=>Y(e).filter(s=>s.size>=6).length*5,evaluateWithDetails:e=>{const n=Y(e).filter(r=>r.size>=6),s=[];for(const r of n)for(const i of r.segments)s.some(a=>a.x===i.x&&a.y===i.y)||s.push({x:i.x,y:i.y});const o=n.length*5;return{points:o,relevantTiles:s,description:`${n.length} potential loop(s) with 6+ segments = ${o} points`}}},"diversity-bonus":{id:"diversity-bonus",name:"Mixed Development",description:"+3 points for each different zone type you have at least 3 tiles of",targetContribution:12,evaluate:e=>{const t=$(e),n={residential:0,commercial:0,industrial:0,park:0};for(const o of t)n[o.type]++;return Object.values(n).filter(o=>o>=3).length*3},evaluateWithDetails:e=>{const t=$(e),n={residential:0,commercial:0,industrial:0,park:0};for(const i of t)n[i.type]++;const s=[],o=[];for(const[i,a]of Object.entries(n))if(a>=3){o.push(i);const c=t.filter(l=>l.type===i);for(const l of c)s.push({x:l.x,y:l.y})}const r=o.length*3;return{points:r,relevantTiles:s,description:`${o.length} zone type(s) with 3+ tiles: ${o.join(", ")} = ${r} points`}}},"longest-road":{id:"longest-road",name:"Major Highway",description:"+1 point for each segment in your longest road network",targetContribution:8,evaluate:e=>{const t=Y(e);return t.length===0?0:t.reduce((s,o)=>o.size>s.size?o:s).size},evaluateWithDetails:e=>{const t=Y(e),n=[];if(t.length===0)return{points:0,relevantTiles:[],description:"No road networks found = 0 points"};const s=t.reduce((o,r)=>r.size>o.size?r:o);for(const o of s.segments)n.some(r=>r.x===o.x&&r.y===o.y)||n.push({x:o.x,y:o.y});return{points:s.size,relevantTiles:n,description:`Longest road network: ${s.size} segments = ${s.size} points`}}},"road-network-count":{id:"road-network-count",name:"Transportation Hub",description:"+4 points if you have exactly 2 road networks, +2 points if you have exactly 3",targetContribution:4,evaluate:e=>{const n=Y(e).length;return n===2?4:n===3?2:0},evaluateWithDetails:e=>{const t=Y(e),n=[],s=t.length;for(const i of t)for(const a of i.segments)n.some(c=>c.x===a.x&&c.y===a.y)||n.push({x:a.x,y:a.y});let o=0,r="";return s===2?(o=4,r="2 road networks = 4 points"):s===3?(o=2,r="3 road networks = 2 points"):r=`${s} road networks = 0 points (need exactly 2 or 3)`,{points:o,relevantTiles:n,description:r}}},"park-chain":{id:"park-chain",name:"Green Corridor",description:"+2 points for each park tile in your largest connected park area",targetContribution:8,evaluate:e=>{const n=W(e).filter(o=>o.type==="park");return n.length===0?0:n.reduce((o,r)=>r.size>o.size?r:o).size*2},evaluateWithDetails:e=>{const n=W(e).filter(i=>i.type==="park"),s=[];if(n.length===0)return{points:0,relevantTiles:[],description:"No park areas found = 0 points"};const o=n.reduce((i,a)=>a.size>i.size?a:i);for(const i of o.tiles)s.push({x:i.x,y:i.y});const r=o.size*2;return{points:r,relevantTiles:s,description:`Largest park area: ${o.size} tiles × 2 = ${r} points`}}},"industrial-isolation":{id:"industrial-isolation",name:"Industrial Zone",description:"+3 points for each industrial tile not adjacent to residential tiles",targetContribution:9,evaluate:e=>{const t=$(e),n=t.filter(r=>r.type==="industrial"),s=t.filter(r=>r.type==="residential");let o=0;for(const r of n)s.some(a=>{const c=Math.abs(r.x-a.x),l=Math.abs(r.y-a.y);return c===1&&l===0||c===0&&l===1})||(o+=3);return o},evaluateWithDetails:e=>{const t=$(e),n=t.filter(i=>i.type==="industrial"),s=t.filter(i=>i.type==="residential"),o=[];let r=0;for(const i of n)s.filter(c=>{const l=Math.abs(i.x-c.x),p=Math.abs(i.y-c.y);return l===1&&p===0||l===0&&p===1}).length===0&&(r+=3,o.push({x:i.x,y:i.y}));return{points:r,relevantTiles:o,description:`${r/3} isolated industrial tiles = ${r} points`}}},"commercial-density":{id:"commercial-density",name:"Shopping District",description:"+1 point for each commercial tile adjacent to 2+ other commercial tiles",targetContribution:6,evaluate:e=>{const n=$(e).filter(o=>o.type==="commercial");let s=0;for(const o of n)n.filter(i=>{if(i.x===o.x&&i.y===o.y)return!1;const a=Math.abs(o.x-i.x),c=Math.abs(o.y-i.y);return a===1&&c===0||a===0&&c===1}).length>=2&&(s+=1);return s},evaluateWithDetails:e=>{const n=$(e).filter(r=>r.type==="commercial"),s=[];let o=0;for(const r of n){const i=n.filter(a=>{if(a.x===r.x&&a.y===r.y)return!1;const c=Math.abs(r.x-a.x),l=Math.abs(r.y-a.y);return c===1&&l===0||c===0&&l===1});if(i.length>=2){o+=1,s.push({x:r.x,y:r.y});for(const a of i)s.some(c=>c.x===a.x&&c.y===a.y)||s.push({x:a.x,y:a.y})}}return{points:o,relevantTiles:s,description:`${o} commercial tiles with 2+ commercial neighbors = ${o} points`}}},"balanced-city":{id:"balanced-city",name:"Balanced Development",description:"+8 points if you have at least 2 tiles of each zone type",targetContribution:8,evaluate:e=>{const t=$(e),n={residential:0,commercial:0,industrial:0,park:0};for(const o of t)n[o.type]++;return Object.values(n).every(o=>o>=2)?8:0},evaluateWithDetails:e=>{const t=$(e),n={residential:0,commercial:0,industrial:0,park:0};for(const a of t)n[a.type]++;const s=[],o=Object.values(n).every(a=>a>=2);o&&s.push(...t.map(a=>({x:a.x,y:a.y})));const r=o?8:0,i=Object.entries(n).map(([a,c])=>`${a}: ${c}`).join(", ");return{points:r,relevantTiles:s,description:o?`Balanced city (${i}) = 8 points`:`Unbalanced city (${i}) = 0 points (need 2+ of each type)`}}}};class xn{compiledConditions=new Map;scoreCache=new Map;maxExecutionTime=50;constructor(){}hashBoard(t){return t.map(n=>`${n.id}_${n.x}_${n.y}_${n.rotation}`).join("|")}createScoringContext(t){return{tiles:$(t),roadSegments:Ee(t),clusters:W(t),roadNetworks:Y(t),board:t}}async compileCondition(t){const n=`compile_${t.id}_${t.formula}`;if(this.compiledConditions.has(n))return this.compiledConditions.get(n);try{const s=this.createSafeFormula(t.formula),o={id:t.id,name:t.name,description:t.description,targetContribution:t.targetContribution||0,compiledFormula:s,originalFormula:t.formula};return this.compiledConditions.set(n,o),o}catch(s){throw console.error(`Failed to compile condition ${t.name}:`,s),s}}createSafeFormula(t){try{return new Function("context",`
        const { tiles, roadSegments, clusters, roadNetworks, board } = context;
        
        // Helper functions available to formulas
        const countTiles = (type) => tiles.filter(t => t.type === type).length;
        const countAdjacent = (type1, type2) => {
          let count = 0;
          const type1Tiles = tiles.filter(t => t.type === type1);
          const type2Tiles = tiles.filter(t => t.type === type2);
          
          for (const t1 of type1Tiles) {
            for (const t2 of type2Tiles) {
              const dx = Math.abs(t1.x - t2.x);
              const dy = Math.abs(t1.y - t2.y);
              if ((dx === 1 && dy === 0) || (dx === 0 && dy === 1)) {
                count++;
                break;
              }
            }
          }
          return count;
        };
        
        const largestCluster = (type) => {
          const typeClusters = clusters.filter(c => c.type === type);
          if (typeClusters.length === 0) return 0;
          return Math.max(...typeClusters.map(c => c.size));
        };
        
        const longestRoad = () => {
          if (roadNetworks.length === 0) return 0;
          return Math.max(...roadNetworks.map(n => n.size));
        };
        
        // Execute the user's formula
        return ${t};
      `)}catch(n){throw console.error("Formula compilation error:",n),new Error(`Invalid formula syntax: ${n}`)}}async evaluateCondition(t,n){const s=this.hashBoard(n),o=`${t.id}_${s}`;if(this.scoreCache.has(o))return{condition:this.convertToScoringCondition(t),points:this.scoreCache.get(o),fromCache:!0};const r=performance.now();try{const i="compiledFormula"in t?t:await this.compileCondition(t),a=this.createScoringContext(n),c=await this.executeWithTimeout(i.compiledFormula,a),l=performance.now()-r;return this.scoreCache.set(o,c),this.scoreCache.size>1e3&&Array.from(this.scoreCache.keys()).slice(0,500).forEach(d=>this.scoreCache.delete(d)),{condition:this.convertToScoringCondition(i),points:c,executionTime:l}}catch(i){return console.warn(`Error evaluating condition ${t.name}:`,i),{condition:this.convertToScoringCondition(t),points:0,error:i instanceof Error?i.message:"Unknown error"}}}async executeWithTimeout(t,n){return new Promise((s,o)=>{const r=setTimeout(()=>{o(new Error("Formula execution timeout"))},this.maxExecutionTime);try{const i=t(n);clearTimeout(r);const a=Math.max(0,Math.floor(Number(i)||0));s(a)}catch(i){clearTimeout(r),o(i)}})}convertToScoringCondition(t){return{id:t.id,name:t.name,description:t.description,targetContribution:t.targetContribution||0,evaluate:n=>{const s=this.createScoringContext(n);try{return"compiledFormula"in t&&typeof t.compiledFormula=="function"?t.compiledFormula(s):0}catch{return 0}},evaluateWithDetails:n=>{const s=this.createScoringContext(n);try{let o=0;return"compiledFormula"in t&&typeof t.compiledFormula=="function"&&(o=t.compiledFormula(s)),{points:o,relevantTiles:[],description:`${t.name}: ${o} points`}}catch{return{points:0,relevantTiles:[],description:`${t.name}: Error evaluating`}}}}}async evaluateAllConditions(t,n){return await Promise.all(t.map(o=>this.evaluateCondition(o,n)))}clearCache(){this.scoreCache.clear()}precompileConditions(t){return Promise.all(t.map(n=>this.compileCondition(n)))}}const Gt=new xn,_t=2,kt=2,Me=(e,t=[])=>{const n=[];for(const s of e){for(const o of s.baseCards)for(let r=0;r<o.count;r++){const i={id:`${o.id}-${r}`,x:0,y:0,cells:o.cells,rotation:0};n.push(i)}if(s.type!=="custom"&&t.length>0)for(const o of t){const r=s.expansions.find(i=>i.id===o);if(r)for(const i of r.cards)for(let a=0;a<i.count;a++){const c={id:`${i.id}-${a}`,x:0,y:0,cells:i.cells,rotation:0};n.push(c)}}}for(let s=n.length-1;s>0;s--){const o=Math.floor(Math.random()*(s+1));[n[s],n[o]]=[n[o],n[s]]}return n},Jt=(e,t)=>{if(t===0)return{...e,rotation:0};const n=[];for(let s=0;s<kt;s++){n[s]=[];for(let o=0;o<_t;o++){const r=e.cells[kt-1-s][_t-1-o],i=r.roads.map(a=>[(a[0]+2)%4,(a[1]+2)%4]);n[s][o]={type:r.type,roads:i}}}return{...e,cells:n,rotation:t}},Ie=(e,t,n,s)=>{if(s.length===0)return!0;const o=new Set;for(const a of s)for(let c=0;c<kt;c++)for(let l=0;l<_t;l++)o.add(`${a.x+l},${a.y+c}`);let r=!1,i=!0;for(let a=0;a<kt;a++)for(let c=0;c<_t;c++){const l=t+c,p=n+a,d=`${l},${p}`;o.has(d)&&(r=!0,i=!1);const f=[`${l-1},${p}`,`${l+1},${p}`,`${l},${p-1}`,`${l},${p+1}`];for(const m of f)o.has(m)&&(r=!0,i=!1);const h=[`${l-1},${p-1}`,`${l+1},${p-1}`,`${l-1},${p+1}`,`${l+1},${p+1}`];for(const m of h)o.has(m)&&(r=!0)}return r&&!i},Cn=(e,t=[],n=[])=>{const s=t.length>0?t:[gn[0]],o=Me(s,n),r=e.map((_,E)=>({id:`player-${E}`,name:_,hand:[],isActive:!0})),i=o.pop();i.x=0,i.y=0;const a=Math.floor(Math.random()*r.length);r.forEach((_,E)=>{const P=E===a?3:1;for(let R=0;R<P;R++)o.length>0&&_.hand.push(o.pop())});const c=o.length>0?o[o.length-1]:null;let l=[],p=[],d=0;const f=new Set;for(const _ of s){for(const E of _.baseCards)E.scoringConditionId&&f.add(E.scoringConditionId);if(_.type!=="custom"&&n.length>0)for(const E of n){const P=_.expansions.find(R=>R.id===E);if(P)for(const R of P.cards)R.scoringConditionId&&f.add(R.scoringConditionId)}}const h=s.filter(_=>"isCustom"in _&&_.isCustom);for(const _ of h)if(_.customScoringConditions)for(const E of _.customScoringConditions){const P={id:E.id,name:E.name,description:E.description,targetContribution:E.targetContribution||0,evaluate:R=>0};E.isGlobal?p.push(P):f.has(E.id)&&l.push(P)}for(const _ of f){const E=$e[_];E&&!l.some(P=>P.id===_)&&l.push(E)}const m=l.slice(0,3),v=[...p,...m];d=v.reduce((_,E)=>_+(E.targetContribution||0),0);const T=h.flatMap(_=>_.customScoringConditions||[]);return T.length>0&&Gt.precompileConditions(T).catch(console.error),{players:r,currentPlayerIndex:a,deck:o,board:[i],topCard:c,gamePhase:"playing",turnCount:0,scoring:{activeConditions:v.map(_=>({id:_.id,name:_.name,description:_.description})),targetScore:d,customConditions:T}}},wn=(e,t,n,s,o,r=0)=>{const i=e.players.findIndex(v=>v.id===t);if(i===-1||i!==e.currentPlayerIndex)return null;const a=e.players[i],c=a.hand.findIndex(v=>v.id===n);if(c===-1)return null;let l=a.hand[c];if(l=Jt(l,r),l.x=s,l.y=o,!Ie(l,s,o,e.board))return null;const p=[...a.hand];p.splice(c,1);const d=(i+1)%e.players.length,f=e.players.map((v,T)=>{if(T===i){const _=e.deck.length>0?e.deck[e.deck.length-1]:null;return{...v,hand:_?[_]:[]}}else if(T===d)return{...v,hand:[...v.hand,...p]};return v}),h=[...e.deck];h.length>0&&h.pop();const m=h.length>0?h[h.length-1]:null;return{...e,players:f,currentPlayerIndex:d,deck:h,board:[...e.board,l],topCard:m,turnCount:e.turnCount+1}},Tn=e=>{if(!e.scoring)return le(e.board);const t=e.scoring.activeConditions.map(o=>$e[o.id]).filter(Boolean),n=[];e.scoring.customConditions&&e.scoring.customConditions.length>0&&e.scoring.customConditions.forEach(o=>{e.scoring?.activeConditions.some(r=>r.id===o.id)&&n.push({id:o.id,name:o.name,description:o.description,targetContribution:o.targetContribution||0,evaluate:r=>{try{const i=Gt.createScoringContext(r);return Gt.createSafeFormula(o.formula)(i)}catch{return 0}}})});const s=[...t,...n];return le(e.board,s)},Us=Object.freeze(Object.defineProperty({__proto__:null,generateDeckFromVariations:Me,getCurrentScore:Tn,initializeGame:Cn,isValidPlacement:Ie,playCard:wn,rotateCard:Jt},Symbol.toStringTag,{value:"Module"})),Sn=(e,t)=>{if(t){const n=t.find(s=>s.id===e);if(n)return n.color}switch(e){case"residential":return"#60a5fa";case"commercial":return"#f59e0b";case"industrial":return"#6b7280";case"park":return"#34d399";default:return"#e5e7eb"}},_n=({segment:e,cellWidth:t,cellHeight:n})=>{const[s,o]=e,r={0:{x:50,y:0},1:{x:100,y:50},2:{x:50,y:100},3:{x:0,y:50}},i=r[s],a=r[o],c={x:50,y:50},l=(s+o)%2===0,p=Math.max(2,Math.min(t,n)*.2),d=Math.max(1,p*.15);return l?G.jsxs("svg",{className:"absolute inset-0 pointer-events-none",style:{zIndex:1},viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[G.jsx("line",{x1:i.x,y1:i.y,x2:a.x,y2:a.y,stroke:"#374151",strokeWidth:p,strokeLinecap:"round"}),G.jsx("line",{x1:i.x,y1:i.y,x2:a.x,y2:a.y,stroke:"#fbbf24",strokeWidth:d,strokeLinecap:"round"})]}):G.jsxs("svg",{className:"absolute inset-0 pointer-events-none",style:{zIndex:1},viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[G.jsx("polyline",{points:`${i.x},${i.y} ${c.x},${c.y} ${a.x},${a.y}`,fill:"none",stroke:"#374151",strokeWidth:p,strokeLinecap:"round",strokeLinejoin:"round"}),G.jsx("polyline",{points:`${i.x},${i.y} ${c.x},${c.y} ${a.x},${a.y}`,fill:"none",stroke:"#fbbf24",strokeWidth:d,strokeLinecap:"round",strokeLinejoin:"round"})]})};function Ks({card:e,width:t,height:n,rotation:s=0,showBorder:o=!0,borderColor:r="border-gray-400",className:i="",zoneTypes:a,showLabels:c=!0}){const l=s!==0&&"x"in e&&"y"in e&&"rotation"in e?Jt(e,s):e,p=t/2,d=n/2;return G.jsx("div",{className:`${o?`border-2 ${r}`:""} rounded overflow-hidden ${i}`,style:{width:`${t}px`,height:`${n}px`},children:G.jsx("div",{className:"grid grid-cols-2 grid-rows-2 h-full w-full",children:l.cells.map((f,h)=>f.map((m,v)=>G.jsx("div",{className:"relative",style:{backgroundColor:Sn(m.type,a)},children:m.roads.map((T,_)=>G.jsx(_n,{segment:T,cellWidth:p,cellHeight:d},_))},`${h}-${v}`))).flat()})})}var kn=F.useLayoutEffect;function En(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global}function $n(){const e=En();if(e.__xstate__)return e.__xstate__}const Mn=e=>{if(typeof window>"u")return;const t=$n();t&&t.register(e)};class ue{constructor(t){this._process=t,this._active=!1,this._current=null,this._last=null}start(){this._active=!0,this.flush()}clear(){this._current&&(this._current.next=null,this._last=this._current)}enqueue(t){const n={value:t,next:null};if(this._current){this._last.next=n,this._last=n;return}this._current=n,this._last=n,this._active&&this.flush()}flush(){for(;this._current;){const t=this._current;this._process(t.value),this._current=t.next}this._last=null}}const Ae=".",In="",Re="",An="#",Rn="*",je="xstate.init",Et="xstate.stop";function jn(e,t){return{type:`xstate.after.${e}.${t}`}}function Vt(e,t){return{type:`xstate.done.state.${e}`,output:t}}function Dn(e,t){return{type:`xstate.done.actor.${e}`,output:t,actorId:e}}function On(e,t){return{type:`xstate.error.actor.${e}`,error:t,actorId:e}}function De(e){return{type:je,input:e}}function K(e){setTimeout(()=>{throw e})}const Pn=typeof Symbol=="function"&&Symbol.observable||"@@observable";function Oe(e,t){const n=de(e),s=de(t);return typeof s=="string"?typeof n=="string"?s===n:!1:typeof n=="string"?n in s:Object.keys(n).every(o=>o in s?Oe(n[o],s[o]):!1)}function Zt(e){if(ze(e))return e;const t=[];let n="";for(let s=0;s<e.length;s++){switch(e.charCodeAt(s)){case 92:n+=e[s+1],s++;continue;case 46:t.push(n),n="";continue}n+=e[s]}return t.push(n),t}function de(e){if(ys(e))return e.value;if(typeof e!="string")return e;const t=Zt(e);return zn(t)}function zn(e){if(e.length===1)return e[0];const t={};let n=t;for(let s=0;s<e.length-1;s++)if(s===e.length-2)n[e[s]]=e[s+1];else{const o=n;n={},o[e[s]]=n}return t}function fe(e,t){const n={},s=Object.keys(e);for(let o=0;o<s.length;o++){const r=s[o];n[r]=t(e[r],r,e,o)}return n}function Pe(e){return ze(e)?e:[e]}function Z(e){return e===void 0?[]:Pe(e)}function qt(e,t,n,s){return typeof e=="function"?e({context:t,event:n,self:s}):e}function ze(e){return Array.isArray(e)}function Ln(e){return e.type.startsWith("xstate.error.actor")}function it(e){return Pe(e).map(t=>typeof t>"u"||typeof t=="string"?{target:t}:t)}function Le(e){if(!(e===void 0||e===In))return Z(e)}function $t(e,t,n){const s=typeof e=="object",o=s?e:void 0;return{next:(s?e.next:e)?.bind(o),error:(s?e.error:t)?.bind(o),complete:(s?e.complete:n)?.bind(o)}}function pe(e,t){return`${t}.${e}`}function Qt(e,t){const n=t.match(/^xstate\.invoke\.(\d+)\.(.*)/);if(!n)return e.implementations.actors[t];const[,s,o]=n,i=e.getStateNodeById(o).config.invoke;return(Array.isArray(i)?i[s]:i).src}function he(e,t){return`${e.sessionId}.${t}`}let Wn=0;function Nn(e,t){const n=new Map,s=new Map,o=new WeakMap,r=new Set,i={},{clock:a,logger:c}=t,l={schedule:(f,h,m,v,T=Math.random().toString(36).slice(2))=>{const _={source:f,target:h,event:m,delay:v,id:T,startedAt:Date.now()},E=he(f,T);d._snapshot._scheduledEvents[E]=_;const P=a.setTimeout(()=>{delete i[E],delete d._snapshot._scheduledEvents[E],d._relay(f,h,m)},v);i[E]=P},cancel:(f,h)=>{const m=he(f,h),v=i[m];delete i[m],delete d._snapshot._scheduledEvents[m],v!==void 0&&a.clearTimeout(v)},cancelAll:f=>{for(const h in d._snapshot._scheduledEvents){const m=d._snapshot._scheduledEvents[h];m.source===f&&l.cancel(f,m.id)}}},p=f=>{if(!r.size)return;const h={...f,rootId:e.sessionId};r.forEach(m=>m.next?.(h))},d={_snapshot:{_scheduledEvents:(t?.snapshot&&t.snapshot.scheduler)??{}},_bookId:()=>`x:${Wn++}`,_register:(f,h)=>(n.set(f,h),f),_unregister:f=>{n.delete(f.sessionId);const h=o.get(f);h!==void 0&&(s.delete(h),o.delete(f))},get:f=>s.get(f),_set:(f,h)=>{const m=s.get(f);if(m&&m!==h)throw new Error(`Actor with system ID '${f}' already exists.`);s.set(f,h),o.set(h,f)},inspect:f=>{const h=$t(f);return r.add(h),{unsubscribe(){r.delete(h)}}},_sendInspectionEvent:p,_relay:(f,h,m)=>{d._sendInspectionEvent({type:"@xstate.event",sourceRef:f,actorRef:h,event:m}),h._send(m)},scheduler:l,getSnapshot:()=>({_scheduledEvents:{...d._snapshot._scheduledEvents}}),start:()=>{const f=d._snapshot._scheduledEvents;d._snapshot._scheduledEvents={};for(const h in f){const{source:m,target:v,event:T,delay:_,id:E}=f[h];l.schedule(m,v,T,_,E)}},_clock:a,_logger:c};return d}let Pt=!1;const te=1;let B=(function(e){return e[e.NotStarted=0]="NotStarted",e[e.Running=1]="Running",e[e.Stopped=2]="Stopped",e})({});const Fn={clock:{setTimeout:(e,t)=>setTimeout(e,t),clearTimeout:e=>clearTimeout(e)},logger:console.log.bind(console),devTools:!1};class Hn{constructor(t,n){this.logic=t,this._snapshot=void 0,this.clock=void 0,this.options=void 0,this.id=void 0,this.mailbox=new ue(this._process.bind(this)),this.observers=new Set,this.eventListeners=new Map,this.logger=void 0,this._processingStatus=B.NotStarted,this._parent=void 0,this._syncSnapshot=void 0,this.ref=void 0,this._actorScope=void 0,this._systemId=void 0,this.sessionId=void 0,this.system=void 0,this._doneEvent=void 0,this.src=void 0,this._deferred=[];const s={...Fn,...n},{clock:o,logger:r,parent:i,syncSnapshot:a,id:c,systemId:l,inspect:p}=s;this.system=i?i.system:Nn(this,{clock:o,logger:r}),p&&!i&&this.system.inspect($t(p)),this.sessionId=this.system._bookId(),this.id=c??this.sessionId,this.logger=n?.logger??this.system._logger,this.clock=n?.clock??this.system._clock,this._parent=i,this._syncSnapshot=a,this.options=s,this.src=s.src??t,this.ref=this,this._actorScope={self:this,id:this.id,sessionId:this.sessionId,logger:this.logger,defer:d=>{this._deferred.push(d)},system:this.system,stopChild:d=>{if(d._parent!==this)throw new Error(`Cannot stop child actor ${d.id} of ${this.id} because it is not a child`);d._stop()},emit:d=>{const f=this.eventListeners.get(d.type),h=this.eventListeners.get("*");if(!f&&!h)return;const m=[...f?f.values():[],...h?h.values():[]];for(const v of m)try{v(d)}catch(T){K(T)}},actionExecutor:d=>{const f=()=>{if(this._actorScope.system._sendInspectionEvent({type:"@xstate.action",actorRef:this,action:{type:d.type,params:d.params}}),!d.exec)return;const h=Pt;try{Pt=!0,d.exec(d.info,d.params)}finally{Pt=h}};this._processingStatus===B.Running?f():this._deferred.push(f)}},this.send=this.send.bind(this),this.system._sendInspectionEvent({type:"@xstate.actor",actorRef:this}),l&&(this._systemId=l,this.system._set(l,this)),this._initState(n?.snapshot??n?.state),l&&this._snapshot.status!=="active"&&this.system._unregister(this)}_initState(t){try{this._snapshot=t?this.logic.restoreSnapshot?this.logic.restoreSnapshot(t,this._actorScope):t:this.logic.getInitialSnapshot(this._actorScope,this.options?.input)}catch(n){this._snapshot={status:"error",output:void 0,error:n}}}update(t,n){this._snapshot=t;let s;for(;s=this._deferred.shift();)try{s()}catch(o){this._deferred.length=0,this._snapshot={...t,status:"error",error:o}}switch(this._snapshot.status){case"active":for(const o of this.observers)try{o.next?.(t)}catch(r){K(r)}break;case"done":for(const o of this.observers)try{o.next?.(t)}catch(r){K(r)}this._stopProcedure(),this._complete(),this._doneEvent=Dn(this.id,this._snapshot.output),this._parent&&this.system._relay(this,this._parent,this._doneEvent);break;case"error":this._error(this._snapshot.error);break}this.system._sendInspectionEvent({type:"@xstate.snapshot",actorRef:this,event:n,snapshot:t})}subscribe(t,n,s){const o=$t(t,n,s);if(this._processingStatus!==B.Stopped)this.observers.add(o);else switch(this._snapshot.status){case"done":try{o.complete?.()}catch(r){K(r)}break;case"error":{const r=this._snapshot.error;if(!o.error)K(r);else try{o.error(r)}catch(i){K(i)}break}}return{unsubscribe:()=>{this.observers.delete(o)}}}on(t,n){let s=this.eventListeners.get(t);s||(s=new Set,this.eventListeners.set(t,s));const o=n.bind(void 0);return s.add(o),{unsubscribe:()=>{s.delete(o)}}}start(){if(this._processingStatus===B.Running)return this;this._syncSnapshot&&this.subscribe({next:s=>{s.status==="active"&&this.system._relay(this,this._parent,{type:`xstate.snapshot.${this.id}`,snapshot:s})},error:()=>{}}),this.system._register(this.sessionId,this),this._systemId&&this.system._set(this._systemId,this),this._processingStatus=B.Running;const t=De(this.options.input);switch(this.system._sendInspectionEvent({type:"@xstate.event",sourceRef:this._parent,actorRef:this,event:t}),this._snapshot.status){case"done":return this.update(this._snapshot,t),this;case"error":return this._error(this._snapshot.error),this}if(this._parent||this.system.start(),this.logic.start)try{this.logic.start(this._snapshot,this._actorScope)}catch(s){return this._snapshot={...this._snapshot,status:"error",error:s},this._error(s),this}return this.update(this._snapshot,t),this.options.devTools&&this.attachDevTools(),this.mailbox.start(),this}_process(t){let n,s;try{n=this.logic.transition(this._snapshot,t,this._actorScope)}catch(o){s={err:o}}if(s){const{err:o}=s;this._snapshot={...this._snapshot,status:"error",error:o},this._error(o);return}this.update(n,t),t.type===Et&&(this._stopProcedure(),this._complete())}_stop(){return this._processingStatus===B.Stopped?this:(this.mailbox.clear(),this._processingStatus===B.NotStarted?(this._processingStatus=B.Stopped,this):(this.mailbox.enqueue({type:Et}),this))}stop(){if(this._parent)throw new Error("A non-root actor cannot be stopped directly.");return this._stop()}_complete(){for(const t of this.observers)try{t.complete?.()}catch(n){K(n)}this.observers.clear()}_reportError(t){if(!this.observers.size){this._parent||K(t);return}let n=!1;for(const s of this.observers){const o=s.error;n||=!o;try{o?.(t)}catch(r){K(r)}}this.observers.clear(),n&&K(t)}_error(t){this._stopProcedure(),this._reportError(t),this._parent&&this.system._relay(this,this._parent,On(this.id,t))}_stopProcedure(){return this._processingStatus!==B.Running?this:(this.system.scheduler.cancelAll(this),this.mailbox.clear(),this.mailbox=new ue(this._process.bind(this)),this._processingStatus=B.Stopped,this.system._unregister(this),this)}_send(t){this._processingStatus!==B.Stopped&&this.mailbox.enqueue(t)}send(t){this.system._relay(void 0,this,t)}attachDevTools(){const{devTools:t}=this.options;t&&(typeof t=="function"?t:Mn)(this)}toJSON(){return{xstate$$type:te,id:this.id}}getPersistedSnapshot(t){return this.logic.getPersistedSnapshot(this._snapshot,t)}[Pn](){return this}getSnapshot(){return this._snapshot}}function ct(e,...[t]){return new Hn(e,t)}function Bn(e,t,n,s,{sendId:o}){const r=typeof o=="function"?o(n,s):o;return[t,{sendId:r},void 0]}function Xn(e,t){e.defer(()=>{e.system.scheduler.cancel(e.self,t.sendId)})}function Yn(e){function t(n,s){}return t.type="xstate.cancel",t.sendId=e,t.resolve=Bn,t.execute=Xn,t}function Gn(e,t,n,s,{id:o,systemId:r,src:i,input:a,syncSnapshot:c}){const l=typeof i=="string"?Qt(t.machine,i):i,p=typeof o=="function"?o(n):o;let d,f;return l&&(f=typeof a=="function"?a({context:t.context,event:n.event,self:e.self}):a,d=ct(l,{id:p,src:i,parent:e.self,syncSnapshot:c,systemId:r,input:f})),[st(t,{children:{...t.children,[p]:d}}),{id:o,systemId:r,actorRef:d,src:i,input:f},void 0]}function Vn(e,{actorRef:t}){t&&e.defer(()=>{t._processingStatus!==B.Stopped&&t.start()})}function qn(...[e,{id:t,systemId:n,input:s,syncSnapshot:o=!1}={}]){function r(i,a){}return r.type="xstate.spawnChild",r.id=t,r.systemId=n,r.src=e,r.input=s,r.syncSnapshot=o,r.resolve=Gn,r.execute=Vn,r}function Un(e,t,n,s,{actorRef:o}){const r=typeof o=="function"?o(n,s):o,i=typeof r=="string"?t.children[r]:r;let a=t.children;return i&&(a={...a},delete a[i.id]),[st(t,{children:a}),i,void 0]}function Kn(e,t){if(t){if(e.system._unregister(t),t._processingStatus!==B.Running){e.stopChild(t);return}e.defer(()=>{e.stopChild(t)})}}function We(e){function t(n,s){}return t.type="xstate.stopChild",t.actorRef=e,t.resolve=Un,t.execute=Kn,t}function ee(e,t,n,s){const{machine:o}=s,r=typeof e=="function",i=r?e:o.implementations.guards[typeof e=="string"?e:e.type];if(!r&&!i)throw new Error(`Guard '${typeof e=="string"?e:e.type}' is not implemented.'.`);if(typeof i!="function")return ee(i,t,n,s);const a={context:t,event:n},c=r||typeof e=="string"?void 0:"params"in e?typeof e.params=="function"?e.params({context:t,event:n}):e.params:void 0;return"check"in i?i.check(s,a,i):i(a,c)}const ne=e=>e.type==="atomic"||e.type==="final";function lt(e){return Object.values(e.states).filter(t=>t.type!=="history")}function yt(e,t){const n=[];if(t===e)return n;let s=e.parent;for(;s&&s!==t;)n.push(s),s=s.parent;return n}function Mt(e){const t=new Set(e),n=Fe(t);for(const s of t)if(s.type==="compound"&&(!n.get(s)||!n.get(s).length))me(s).forEach(o=>t.add(o));else if(s.type==="parallel"){for(const o of lt(s))if(o.type!=="history"&&!t.has(o)){const r=me(o);for(const i of r)t.add(i)}}for(const s of t){let o=s.parent;for(;o;)t.add(o),o=o.parent}return t}function Ne(e,t){const n=t.get(e);if(!n)return{};if(e.type==="compound"){const o=n[0];if(o){if(ne(o))return o.key}else return{}}const s={};for(const o of n)s[o.key]=Ne(o,t);return s}function Fe(e){const t=new Map;for(const n of e)t.has(n)||t.set(n,[]),n.parent&&(t.has(n.parent)||t.set(n.parent,[]),t.get(n.parent).push(n));return t}function He(e,t){const n=Mt(t);return Ne(e,Fe(n))}function se(e,t){return t.type==="compound"?lt(t).some(n=>n.type==="final"&&e.has(n)):t.type==="parallel"?lt(t).every(n=>se(e,n)):t.type==="final"}const jt=e=>e[0]===An;function Jn(e,t){return e.transitions.get(t)||[...e.transitions.keys()].filter(s=>{if(s===Rn)return!0;if(!s.endsWith(".*"))return!1;const o=s.split("."),r=t.split(".");for(let i=0;i<o.length;i++){const a=o[i],c=r[i];if(a==="*")return i===o.length-1;if(a!==c)return!1}return!0}).sort((s,o)=>o.length-s.length).flatMap(s=>e.transitions.get(s))}function Zn(e){const t=e.config.after;if(!t)return[];const n=o=>{const r=jn(o,e.id),i=r.type;return e.entry.push(ks(r,{id:i,delay:o})),e.exit.push(Yn(i)),i};return Object.keys(t).flatMap(o=>{const r=t[o],i=typeof r=="string"?{target:r}:r,a=Number.isNaN(+o)?o:+o,c=n(a);return Z(i).map(l=>({...l,event:c,delay:a}))}).map(o=>{const{delay:r}=o;return{...et(e,o.event,o),delay:r}})}function et(e,t,n){const s=Le(n.target),o=n.reenter??!1,r=es(e,s),i={...n,actions:Z(n.actions),guard:n.guard,target:r,source:e,reenter:o,eventType:t,toJSON:()=>({...i,source:`#${e.id}`,target:r?r.map(a=>`#${a.id}`):void 0})};return i}function Qn(e){const t=new Map;if(e.config.on)for(const n of Object.keys(e.config.on)){if(n===Re)throw new Error('Null events ("") cannot be specified as a transition key. Use `always: { ... }` instead.');const s=e.config.on[n];t.set(n,it(s).map(o=>et(e,n,o)))}if(e.config.onDone){const n=`xstate.done.state.${e.id}`;t.set(n,it(e.config.onDone).map(s=>et(e,n,s)))}for(const n of e.invoke){if(n.onDone){const s=`xstate.done.actor.${n.id}`;t.set(s,it(n.onDone).map(o=>et(e,s,o)))}if(n.onError){const s=`xstate.error.actor.${n.id}`;t.set(s,it(n.onError).map(o=>et(e,s,o)))}if(n.onSnapshot){const s=`xstate.snapshot.${n.id}`;t.set(s,it(n.onSnapshot).map(o=>et(e,s,o)))}}for(const n of e.after){let s=t.get(n.eventType);s||(s=[],t.set(n.eventType,s)),s.push(n)}return t}function ts(e,t){const n=typeof t=="string"?e.states[t]:t?e.states[t.target]:void 0;if(!n&&t)throw new Error(`Initial state node "${t}" not found on parent state node #${e.id}`);const s={source:e,actions:!t||typeof t=="string"?[]:Z(t.actions),eventType:null,reenter:!1,target:n?[n]:[],toJSON:()=>({...s,source:`#${e.id}`,target:n?[`#${n.id}`]:[]})};return s}function es(e,t){if(t!==void 0)return t.map(n=>{if(typeof n!="string")return n;if(jt(n))return e.machine.getStateNodeById(n);const s=n[0]===Ae;if(s&&!e.parent)return It(e,n.slice(1));const o=s?e.key+n:n;if(e.parent)try{return It(e.parent,o)}catch(r){throw new Error(`Invalid transition definition for state node '${e.id}':
${r.message}`)}else throw new Error(`Invalid target: "${n}" is not a valid target from the root node. Did you mean ".${n}"?`)})}function Be(e){const t=Le(e.config.target);return t?{target:t.map(n=>typeof n=="string"?It(e.parent,n):n)}:e.parent.initial}function nt(e){return e.type==="history"}function me(e){const t=Xe(e);for(const n of t)for(const s of yt(n,e))t.add(s);return t}function Xe(e){const t=new Set;function n(s){if(!t.has(s)){if(t.add(s),s.type==="compound")n(s.initial.target[0]);else if(s.type==="parallel")for(const o of lt(s))n(o)}}return n(e),t}function ut(e,t){if(jt(t))return e.machine.getStateNodeById(t);if(!e.states)throw new Error(`Unable to retrieve child state '${t}' from '${e.id}'; no child states exist.`);const n=e.states[t];if(!n)throw new Error(`Child state '${t}' does not exist on '${e.id}'`);return n}function It(e,t){if(typeof t=="string"&&jt(t))try{return e.machine.getStateNodeById(t)}catch{}const n=Zt(t).slice();let s=e;for(;n.length;){const o=n.shift();if(!o.length)break;s=ut(s,o)}return s}function At(e,t){if(typeof t=="string"){const o=e.states[t];if(!o)throw new Error(`State '${t}' does not exist on '${e.id}'`);return[e,o]}const n=Object.keys(t),s=n.map(o=>ut(e,o)).filter(Boolean);return[e.machine.root,e].concat(s,n.reduce((o,r)=>{const i=ut(e,r);if(!i)return o;const a=At(i,t[r]);return o.concat(a)},[]))}function ns(e,t,n,s){const r=ut(e,t).next(n,s);return!r||!r.length?e.next(n,s):r}function ss(e,t,n,s){const o=Object.keys(t),r=ut(e,o[0]),i=oe(r,t[o[0]],n,s);return!i||!i.length?e.next(n,s):i}function os(e,t,n,s){const o=[];for(const r of Object.keys(t)){const i=t[r];if(!i)continue;const a=ut(e,r),c=oe(a,i,n,s);c&&o.push(...c)}return o.length?o:e.next(n,s)}function oe(e,t,n,s){return typeof t=="string"?ns(e,t,n,s):Object.keys(t).length===1?ss(e,t,n,s):os(e,t,n,s)}function rs(e){return Object.keys(e.states).map(t=>e.states[t]).filter(t=>t.type==="history")}function Q(e,t){let n=e;for(;n.parent&&n.parent!==t;)n=n.parent;return n.parent===t}function is(e,t){const n=new Set(e),s=new Set(t);for(const o of n)if(s.has(o))return!0;for(const o of s)if(n.has(o))return!0;return!1}function Ye(e,t,n){const s=new Set;for(const o of e){let r=!1;const i=new Set;for(const a of s)if(is(Ut([o],t,n),Ut([a],t,n)))if(Q(o.source,a.source))i.add(a);else{r=!0;break}if(!r){for(const a of i)s.delete(a);s.add(o)}}return Array.from(s)}function as(e){const[t,...n]=e;for(const s of yt(t,void 0))if(n.every(o=>Q(o,s)))return s}function re(e,t){if(!e.target)return[];const n=new Set;for(const s of e.target)if(nt(s))if(t[s.id])for(const o of t[s.id])n.add(o);else for(const o of re(Be(s),t))n.add(o);else n.add(s);return[...n]}function Ge(e,t){const n=re(e,t);if(!n)return;if(!e.reenter&&n.every(o=>o===e.source||Q(o,e.source)))return e.source;const s=as(n.concat(e.source));if(s)return s;if(!e.reenter)return e.source.machine.root}function Ut(e,t,n){const s=new Set;for(const o of e)if(o.target?.length){const r=Ge(o,n);o.reenter&&o.source===r&&s.add(r);for(const i of t)Q(i,r)&&s.add(i)}return[...s]}function cs(e,t){if(e.length!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}function Kt(e,t,n,s,o,r){if(!e.length)return t;const i=new Set(t._nodes);let a=t.historyValue;const c=Ye(e,i,a);let l=t;o||([l,a]=fs(l,s,n,c,i,a,r,n.actionExecutor)),l=dt(l,s,n,c.flatMap(d=>d.actions),r,void 0),l=us(l,s,n,c,i,r,a,o);const p=[...i];l.status==="done"&&(l=dt(l,s,n,p.sort((d,f)=>f.order-d.order).flatMap(d=>d.exit),r,void 0));try{return a===t.historyValue&&cs(t._nodes,i)?l:st(l,{_nodes:p,historyValue:a})}catch(d){throw d}}function ls(e,t,n,s,o){if(s.output===void 0)return;const r=Vt(o.id,o.output!==void 0&&o.parent?qt(o.output,e.context,t,n.self):void 0);return qt(s.output,e.context,r,n.self)}function us(e,t,n,s,o,r,i,a){let c=e;const l=new Set,p=new Set;ds(s,i,p,l),a&&p.add(e.machine.root);const d=new Set;for(const f of[...l].sort((h,m)=>h.order-m.order)){o.add(f);const h=[];h.push(...f.entry);for(const m of f.invoke)h.push(qn(m.src,{...m,syncSnapshot:!!m.onSnapshot}));if(p.has(f)){const m=f.initial.actions;h.push(...m)}if(c=dt(c,t,n,h,r,f.invoke.map(m=>m.id)),f.type==="final"){const m=f.parent;let v=m?.type==="parallel"?m:m?.parent,T=v||f;for(m?.type==="compound"&&r.push(Vt(m.id,f.output!==void 0?qt(f.output,c.context,t,n.self):void 0));v?.type==="parallel"&&!d.has(v)&&se(o,v);)d.add(v),r.push(Vt(v.id)),T=v,v=v.parent;if(v)continue;c=st(c,{status:"done",output:ls(c,t,n,c.machine.root,T)})}}return c}function ds(e,t,n,s){for(const o of e){const r=Ge(o,t);for(const a of o.target||[])!nt(a)&&(o.source!==a||o.source!==r||o.reenter)&&(s.add(a),n.add(a)),at(a,t,n,s);const i=re(o,t);for(const a of i){const c=yt(a,r);r?.type==="parallel"&&c.push(r),Ve(s,t,n,c,!o.source.parent&&o.reenter?void 0:r)}}}function at(e,t,n,s){if(nt(e))if(t[e.id]){const o=t[e.id];for(const r of o)s.add(r),at(r,t,n,s);for(const r of o)zt(r,e.parent,s,t,n)}else{const o=Be(e);for(const r of o.target)s.add(r),o===e.parent?.initial&&n.add(e.parent),at(r,t,n,s);for(const r of o.target)zt(r,e.parent,s,t,n)}else if(e.type==="compound"){const[o]=e.initial.target;nt(o)||(s.add(o),n.add(o)),at(o,t,n,s),zt(o,e,s,t,n)}else if(e.type==="parallel")for(const o of lt(e).filter(r=>!nt(r)))[...s].some(r=>Q(r,o))||(nt(o)||(s.add(o),n.add(o)),at(o,t,n,s))}function Ve(e,t,n,s,o){for(const r of s)if((!o||Q(r,o))&&e.add(r),r.type==="parallel")for(const i of lt(r).filter(a=>!nt(a)))[...e].some(a=>Q(a,i))||(e.add(i),at(i,t,n,e))}function zt(e,t,n,s,o){Ve(n,s,o,yt(e,t))}function fs(e,t,n,s,o,r,i,a){let c=e;const l=Ut(s,o,r);l.sort((d,f)=>f.order-d.order);let p;for(const d of l)for(const f of rs(d)){let h;f.history==="deep"?h=m=>ne(m)&&Q(m,d):h=m=>m.parent===d,p??={...r},p[f.id]=Array.from(o).filter(h)}for(const d of l)c=dt(c,t,n,[...d.exit,...d.invoke.map(f=>We(f.id))],i,void 0),o.delete(d);return[c,p||r]}function ps(e,t){return e.implementations.actions[t]}function qe(e,t,n,s,o,r){const{machine:i}=e;let a=e;for(const c of s){const l=typeof c=="function",p=l?c:ps(i,typeof c=="string"?c:c.type),d={context:a.context,event:t,self:n.self,system:n.system},f=l||typeof c=="string"?void 0:"params"in c?typeof c.params=="function"?c.params({context:a.context,event:t}):c.params:void 0;if(!p||!("resolve"in p)){n.actionExecutor({type:typeof c=="string"?c:typeof c=="object"?c.type:c.name||"(anonymous)",info:d,params:f,exec:p});continue}const h=p,[m,v,T]=h.resolve(n,a,d,f,p,o);a=m,"retryResolve"in h&&r?.push([h,v]),"execute"in h&&n.actionExecutor({type:h.type,info:d,params:v,exec:h.execute.bind(null,n,v)}),T&&(a=qe(a,t,n,T,o,r))}return a}function dt(e,t,n,s,o,r){const i=r?[]:void 0,a=qe(e,t,n,s,{internalQueue:o,deferredActorIds:r},i);return i?.forEach(([c,l])=>{c.retryResolve(n,a,l)}),a}function Lt(e,t,n,s){let o=e;const r=[];function i(l,p,d){n.system._sendInspectionEvent({type:"@xstate.microstep",actorRef:n.self,event:p,snapshot:l,_transitions:d}),r.push(l)}if(t.type===Et)return o=st(ye(o,t,n),{status:"stopped"}),i(o,t,[]),{snapshot:o,microstates:r};let a=t;if(a.type!==je){const l=a,p=Ln(l),d=ge(l,o);if(p&&!d.length)return o=st(e,{status:"error",error:l.error}),i(o,l,[]),{snapshot:o,microstates:r};o=Kt(d,e,n,a,!1,s),i(o,l,d)}let c=!0;for(;o.status==="active";){let l=c?hs(o,a):[];const p=l.length?o:void 0;if(!l.length){if(!s.length)break;a=s.shift(),l=ge(a,o)}o=Kt(l,o,n,a,!1,s),c=o!==p,i(o,a,l)}return o.status!=="active"&&ye(o,a,n),{snapshot:o,microstates:r}}function ye(e,t,n){return dt(e,t,n,Object.values(e.children).map(s=>We(s)),[],void 0)}function ge(e,t){return t.machine.getTransitionData(t,e)}function hs(e,t){const n=new Set,s=e._nodes.filter(ne);for(const o of s)t:for(const r of[o].concat(yt(o,void 0)))if(r.always){for(const i of r.always)if(i.guard===void 0||ee(i.guard,e.context,t,e)){n.add(i);break t}}return Ye(Array.from(n),new Set(e._nodes),e.historyValue)}function ms(e,t){const n=Mt(At(e,t));return He(e,[...n])}function ys(e){return!!e&&typeof e=="object"&&"machine"in e&&"value"in e}const gs=function(t){return Oe(t,this.value)},vs=function(t){return this.tags.has(t)},bs=function(t){const n=this.machine.getTransitionData(this,t);return!!n?.length&&n.some(s=>s.target!==void 0||s.actions.length)},xs=function(){const{_nodes:t,tags:n,machine:s,getMeta:o,toJSON:r,can:i,hasTag:a,matches:c,...l}=this;return{...l,tags:Array.from(n)}},Cs=function(){return this._nodes.reduce((t,n)=>(n.meta!==void 0&&(t[n.id]=n.meta),t),{})};function St(e,t){return{status:e.status,output:e.output,error:e.error,machine:t,context:e.context,_nodes:e._nodes,value:He(t.root,e._nodes),tags:new Set(e._nodes.flatMap(n=>n.tags)),children:e.children,historyValue:e.historyValue||{},matches:gs,hasTag:vs,can:bs,getMeta:Cs,toJSON:xs}}function st(e,t={}){return St({...e,...t},e.machine)}function ws(e){if(typeof e!="object"||e===null)return{};const t={};for(const n in e){const s=e[n];Array.isArray(s)&&(t[n]=s.map(o=>({id:o.id})))}return t}function Ts(e,t){const{_nodes:n,tags:s,machine:o,children:r,context:i,can:a,hasTag:c,matches:l,getMeta:p,toJSON:d,...f}=e,h={};for(const v in r){const T=r[v];h[v]={snapshot:T.getPersistedSnapshot(t),src:T.src,systemId:T._systemId,syncSnapshot:T._syncSnapshot}}return{...f,context:Ue(i),children:h,historyValue:ws(f.historyValue)}}function Ue(e){let t;for(const n in e){const s=e[n];if(s&&typeof s=="object")if("sessionId"in s&&"send"in s&&"ref"in s)t??=Array.isArray(e)?e.slice():{...e},t[n]={xstate$$type:te,id:s.id};else{const o=Ue(s);o!==s&&(t??=Array.isArray(e)?e.slice():{...e},t[n]=o)}}return t??e}function Ss(e,t,n,s,{event:o,id:r,delay:i},{internalQueue:a}){const c=t.machine.implementations.delays;if(typeof o=="string")throw new Error(`Only event objects may be used with raise; use raise({ type: "${o}" }) instead`);const l=typeof o=="function"?o(n,s):o;let p;if(typeof i=="string"){const d=c&&c[i];p=typeof d=="function"?d(n,s):d}else p=typeof i=="function"?i(n,s):i;return typeof p!="number"&&a.push(l),[t,{event:l,id:r,delay:p},void 0]}function _s(e,t){const{event:n,delay:s,id:o}=t;if(typeof s=="number"){e.defer(()=>{const r=e.self;e.system.scheduler.schedule(r,r,n,s,o)});return}}function ks(e,t){function n(s,o){}return n.type="xstate.raise",n.event=e,n.id=t?.id,n.delay=t?.delay,n.resolve=Ss,n.execute=_s,n}const ve="xstate.promise.resolve",be="xstate.promise.reject",Tt=new WeakMap;function Js(e){return{config:e,transition:(n,s,o)=>{if(n.status!=="active")return n;switch(s.type){case ve:{const r=s.data;return{...n,status:"done",output:r,input:void 0}}case be:return{...n,status:"error",error:s.data,input:void 0};case Et:return Tt.get(o.self)?.abort(),{...n,status:"stopped",input:void 0};default:return n}},start:(n,{self:s,system:o,emit:r})=>{if(n.status!=="active")return;const i=new AbortController;Tt.set(s,i),Promise.resolve(e({input:n.input,system:o,self:s,signal:i.signal,emit:r})).then(c=>{s.getSnapshot().status==="active"&&(Tt.delete(s),o._relay(s,s,{type:ve,data:c}))},c=>{s.getSnapshot().status==="active"&&(Tt.delete(s),o._relay(s,s,{type:be,data:c}))})},getInitialSnapshot:(n,s)=>({status:"active",output:void 0,error:void 0,input:s}),getPersistedSnapshot:n=>n,restoreSnapshot:n=>n}}function Es(e,{machine:t,context:n},s,o){const r=(i,a)=>{if(typeof i=="string"){const c=Qt(t,i);if(!c)throw new Error(`Actor logic '${i}' not implemented in machine '${t.id}'`);const l=ct(c,{id:a?.id,parent:e.self,syncSnapshot:a?.syncSnapshot,input:typeof a?.input=="function"?a.input({context:n,event:s,self:e.self}):a?.input,src:i,systemId:a?.systemId});return o[l.id]=l,l}else return ct(i,{id:a?.id,parent:e.self,syncSnapshot:a?.syncSnapshot,input:a?.input,src:i,systemId:a?.systemId})};return(i,a)=>{const c=r(i,a);return o[c.id]=c,e.defer(()=>{c._processingStatus!==B.Stopped&&c.start()}),c}}function $s(e,t,n,s,{assignment:o}){if(!t.context)throw new Error("Cannot assign to undefined `context`. Ensure that `context` is defined in the machine config.");const r={},i={context:t.context,event:n.event,spawn:Es(e,t,n.event,r),self:e.self,system:e.system};let a={};if(typeof o=="function")a=o(i,s);else for(const l of Object.keys(o)){const p=o[l];a[l]=typeof p=="function"?p(i,s):p}const c=Object.assign({},t.context,a);return[st(t,{context:c,children:Object.keys(r).length?{...t.children,...r}:t.children}),void 0,void 0]}function Ms(e){function t(n,s){}return t.type="xstate.assign",t.assignment=e,t.resolve=$s,t}const xe=new WeakMap;function rt(e,t,n){let s=xe.get(e);return s?t in s||(s[t]=n()):(s={[t]:n()},xe.set(e,s)),s[t]}const Is={},ht=e=>typeof e=="string"?{type:e}:typeof e=="function"?"resolve"in e?{type:e.type}:{type:e.name}:e;class Rt{constructor(t,n){if(this.config=t,this.key=void 0,this.id=void 0,this.type=void 0,this.path=void 0,this.states=void 0,this.history=void 0,this.entry=void 0,this.exit=void 0,this.parent=void 0,this.machine=void 0,this.meta=void 0,this.output=void 0,this.order=-1,this.description=void 0,this.tags=[],this.transitions=void 0,this.always=void 0,this.parent=n._parent,this.key=n._key,this.machine=n._machine,this.path=this.parent?this.parent.path.concat(this.key):[],this.id=this.config.id||[this.machine.id,...this.path].join(Ae),this.type=this.config.type||(this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.description=this.config.description,this.order=this.machine.idMap.size,this.machine.idMap.set(this.id,this),this.states=this.config.states?fe(this.config.states,(s,o)=>new Rt(s,{_parent:this,_key:o,_machine:this.machine})):Is,this.type==="compound"&&!this.config.initial)throw new Error(`No initial state specified for compound state node "#${this.id}". Try adding { initial: "${Object.keys(this.states)[0]}" } to the state config.`);this.history=this.config.history===!0?"shallow":this.config.history||!1,this.entry=Z(this.config.entry).slice(),this.exit=Z(this.config.exit).slice(),this.meta=this.config.meta,this.output=this.type==="final"||!this.parent?this.config.output:void 0,this.tags=Z(t.tags).slice()}_initialize(){this.transitions=Qn(this),this.config.always&&(this.always=it(this.config.always).map(t=>et(this,Re,t))),Object.keys(this.states).forEach(t=>{this.states[t]._initialize()})}get definition(){return{id:this.id,key:this.key,version:this.machine.version,type:this.type,initial:this.initial?{target:this.initial.target,source:this,actions:this.initial.actions.map(ht),eventType:null,reenter:!1,toJSON:()=>({target:this.initial.target.map(t=>`#${t.id}`),source:`#${this.id}`,actions:this.initial.actions.map(ht),eventType:null})}:void 0,history:this.history,states:fe(this.states,t=>t.definition),on:this.on,transitions:[...this.transitions.values()].flat().map(t=>({...t,actions:t.actions.map(ht)})),entry:this.entry.map(ht),exit:this.exit.map(ht),meta:this.meta,order:this.order||-1,output:this.output,invoke:this.invoke,description:this.description,tags:this.tags}}toJSON(){return this.definition}get invoke(){return rt(this,"invoke",()=>Z(this.config.invoke).map((t,n)=>{const{src:s,systemId:o}=t,r=t.id??pe(this.id,n),i=typeof s=="string"?s:`xstate.invoke.${pe(this.id,n)}`;return{...t,src:i,id:r,systemId:o,toJSON(){const{onDone:a,onError:c,...l}=t;return{...l,type:"xstate.invoke",src:i,id:r}}}}))}get on(){return rt(this,"on",()=>[...this.transitions].flatMap(([n,s])=>s.map(o=>[n,o])).reduce((n,[s,o])=>(n[s]=n[s]||[],n[s].push(o),n),{}))}get after(){return rt(this,"delayedTransitions",()=>Zn(this))}get initial(){return rt(this,"initial",()=>ts(this,this.config.initial))}next(t,n){const s=n.type,o=[];let r;const i=rt(this,`candidates-${s}`,()=>Jn(this,s));for(const a of i){const{guard:c}=a,l=t.context;let p=!1;try{p=!c||ee(c,l,n,t)}catch(d){const f=typeof c=="string"?c:typeof c=="object"?c.type:void 0;throw new Error(`Unable to evaluate guard ${f?`'${f}' `:""}in transition for event '${s}' in state node '${this.id}':
${d.message}`)}if(p){o.push(...a.actions),r=a;break}}return r?[r]:void 0}get events(){return rt(this,"events",()=>{const{states:t}=this,n=new Set(this.ownEvents);if(t)for(const s of Object.keys(t)){const o=t[s];if(o.states)for(const r of o.events)n.add(`${r}`)}return Array.from(n)})}get ownEvents(){const t=new Set([...this.transitions.keys()].filter(n=>this.transitions.get(n).some(s=>!(!s.target&&!s.actions.length&&!s.reenter))));return Array.from(t)}}const As="#";class ie{constructor(t,n){this.config=t,this.version=void 0,this.schemas=void 0,this.implementations=void 0,this.__xstatenode=!0,this.idMap=new Map,this.root=void 0,this.id=void 0,this.states=void 0,this.events=void 0,this.id=t.id||"(machine)",this.implementations={actors:n?.actors??{},actions:n?.actions??{},delays:n?.delays??{},guards:n?.guards??{}},this.version=this.config.version,this.schemas=this.config.schemas,this.transition=this.transition.bind(this),this.getInitialSnapshot=this.getInitialSnapshot.bind(this),this.getPersistedSnapshot=this.getPersistedSnapshot.bind(this),this.restoreSnapshot=this.restoreSnapshot.bind(this),this.start=this.start.bind(this),this.root=new Rt(t,{_key:this.id,_machine:this}),this.root._initialize(),this.states=this.root.states,this.events=this.root.events}provide(t){const{actions:n,guards:s,actors:o,delays:r}=this.implementations;return new ie(this.config,{actions:{...n,...t.actions},guards:{...s,...t.guards},actors:{...o,...t.actors},delays:{...r,...t.delays}})}resolveState(t){const n=ms(this.root,t.value),s=Mt(At(this.root,n));return St({_nodes:[...s],context:t.context||{},children:{},status:se(s,this.root)?"done":t.status||"active",output:t.output,error:t.error,historyValue:t.historyValue},this)}transition(t,n,s){return Lt(t,n,s,[]).snapshot}microstep(t,n,s){return Lt(t,n,s,[]).microstates}getTransitionData(t,n){return oe(this.root,t.value,t,n)||[]}getPreInitialState(t,n,s){const{context:o}=this.config,r=St({context:typeof o!="function"&&o?o:{},_nodes:[this.root],children:{},status:"active"},this);return typeof o=="function"?dt(r,n,t,[Ms(({spawn:a,event:c,self:l})=>o({spawn:a,input:c.input,self:l}))],s,void 0):r}getInitialSnapshot(t,n){const s=De(n),o=[],r=this.getPreInitialState(t,s,o),i=Kt([{target:[...Xe(this.root)],source:this.root,reenter:!0,actions:[],eventType:null,toJSON:null}],r,t,s,!0,o),{snapshot:a}=Lt(i,s,t,o);return a}start(t){Object.values(t.children).forEach(n=>{n.getSnapshot().status==="active"&&n.start()})}getStateNodeById(t){const n=Zt(t),s=n.slice(1),o=jt(n[0])?n[0].slice(As.length):n[0],r=this.idMap.get(o);if(!r)throw new Error(`Child state node '#${o}' does not exist on machine '${this.id}'`);return It(r,s)}get definition(){return this.root.definition}toJSON(){return this.definition}getPersistedSnapshot(t,n){return Ts(t,n)}restoreSnapshot(t,n){const s={},o=t.children;Object.keys(o).forEach(d=>{const f=o[d],h=f.snapshot,m=f.src,v=typeof m=="string"?Qt(this,m):m;if(!v)return;const T=ct(v,{id:d,parent:n.self,syncSnapshot:f.syncSnapshot,snapshot:h,src:m,systemId:f.systemId});s[d]=T});function r(d,f){if(f instanceof Rt)return f;try{return d.machine.getStateNodeById(f.id)}catch{}}function i(d,f){if(!f||typeof f!="object")return{};const h={};for(const m in f){const v=f[m];for(const T of v){const _=r(d,T);_&&(h[m]??=[],h[m].push(_))}}return h}const a=i(this.root,t.historyValue),c=St({...t,children:s,_nodes:Array.from(Mt(At(this.root,t.value))),historyValue:a},this),l=new Set;function p(d,f){if(!l.has(d)){l.add(d);for(const h in d){const m=d[h];if(m&&typeof m=="object"){if("xstate$$type"in m&&m.xstate$$type===te){d[h]=f[m.id];continue}p(m,f)}}}}return p(c.context,s),c}}function Rs(e,t){return new ie(e,t)}function Zs({schemas:e,actors:t,actions:n,guards:s,delays:o}){return{createStateConfig:r=>r,createMachine:r=>Rs({...r,schemas:e},{actors:t,actions:n,guards:s,delays:o})}}var Wt={exports:{}},Nt={},Ft={exports:{}},Ht={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ce;function js(){if(Ce)return Ht;Ce=1;var e=_e();function t(d,f){return d===f&&(d!==0||1/d===1/f)||d!==d&&f!==f}var n=typeof Object.is=="function"?Object.is:t,s=e.useState,o=e.useEffect,r=e.useLayoutEffect,i=e.useDebugValue;function a(d,f){var h=f(),m=s({inst:{value:h,getSnapshot:f}}),v=m[0].inst,T=m[1];return r(function(){v.value=h,v.getSnapshot=f,c(v)&&T({inst:v})},[d,h,f]),o(function(){return c(v)&&T({inst:v}),d(function(){c(v)&&T({inst:v})})},[d]),i(h),h}function c(d){var f=d.getSnapshot;d=d.value;try{var h=f();return!n(d,h)}catch{return!0}}function l(d,f){return f()}var p=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?l:a;return Ht.useSyncExternalStore=e.useSyncExternalStore!==void 0?e.useSyncExternalStore:p,Ht}var we;function Ke(){return we||(we=1,Ft.exports=js()),Ft.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Te;function Ds(){if(Te)return Nt;Te=1;var e=_e(),t=Ke();function n(l,p){return l===p&&(l!==0||1/l===1/p)||l!==l&&p!==p}var s=typeof Object.is=="function"?Object.is:n,o=t.useSyncExternalStore,r=e.useRef,i=e.useEffect,a=e.useMemo,c=e.useDebugValue;return Nt.useSyncExternalStoreWithSelector=function(l,p,d,f,h){var m=r(null);if(m.current===null){var v={hasValue:!1,value:null};m.current=v}else v=m.current;m=a(function(){function _(X){if(!E){if(E=!0,P=X,X=f(X),h!==void 0&&v.hasValue){var J=v.value;if(h(J,X))return R=J}return R=X}if(J=R,s(P,X))return J;var gt=f(X);return h!==void 0&&h(J,gt)?(P=X,J):(P=X,R=gt)}var E=!1,P,R,ft=d===void 0?null:d;return[function(){return _(p())},ft===null?void 0:function(){return _(ft())}]},[p,d,f,h]);var T=o(l,m[0],m[1]);return i(function(){v.hasValue=!0,v.value=T},[T]),c(T),T},Nt}var Se;function Os(){return Se||(Se=1,Wt.exports=Ds()),Wt.exports}var Ps=Os();Ke();const Je=(e,t)=>{t(e);const n=e.getSnapshot().children;n&&Object.values(n).forEach(s=>{Je(s,t)})};function zs(e){const t=[];Je(e,s=>{t.push([s,s.getSnapshot()]),s.observers=new Set});const n=e.system.getSnapshot?.();e.stop(),e.system._snapshot=n,t.forEach(([s,o])=>{s._processingStatus=0,s._snapshot=o})}function Ls(e,...[t]){let[[n,s],o]=F.useState(()=>{const r=ct(e,t);return[e.config,r]});if(e.config!==n){const r=ct(e,{...t,snapshot:s.getPersistedSnapshot({__unsafeAllowInlineActors:!0})});o([e.config,r]),s=r}return kn(()=>{s.logic.implementations=e.implementations}),s}function Ws(e,...[t,n]){const s=Ls(e,t);return F.useEffect(()=>{if(!n)return;const o=s.subscribe($t(n));return()=>{o.unsubscribe()}},[n]),F.useEffect(()=>(s.start(),()=>{zs(s)}),[s]),s}function Ns(e,t){return e===t}function Fs(e,t,n=Ns){const s=F.useCallback(i=>{if(!e)return()=>{};const{unsubscribe:a}=e.subscribe(i);return a},[e]),o=F.useCallback(()=>e?.getSnapshot(),[e]);return Ps.useSyncExternalStoreWithSelector(s,o,o,t,n)}function Qs(e,t){const n=F.createContext(null),s=n.Provider;function o({children:a,logic:c=e,machine:l,options:p}){if(l)throw new Error('The "machine" prop has been deprecated. Please use "logic" instead.');const d=Ws(c,{...t,...p});return F.createElement(s,{value:d,children:a})}o.displayName="ActorProvider";function r(){const a=F.useContext(n);if(!a)throw new Error(`You used a hook from "${o.displayName}" but it's not inside a <${o.displayName}> component.`);return a}function i(a,c){const l=r();return Fs(l,a,c)}return{Provider:o,useActorRef:r,useSelector:i}}async function Hs(e){try{const t=await ke(()=>import("./chunk-Dszta4ZM.js").then(c=>c.t),__vite__mapDeps([0,1,2,3,4,5]));if(!e.includes("calculateScore"))return{source:e,compiled:"",success:!1,error:'Formula must contain a "calculateScore" function',diagnostics:['Missing required "calculateScore" function']};const n=`
${e}

// Export the calculate function for execution
if (typeof calculateScore === 'function') {
  self.calculateScore = calculateScore;
} else {
  throw new Error('calculateScore function not found or not properly defined');
}
`,s={target:t.ScriptTarget.ES2020,module:t.ModuleKind.ESNext,lib:["ES2020"],strict:!0,noImplicitAny:!0,strictNullChecks:!0,strictFunctionTypes:!0,noImplicitReturns:!0,noUnusedLocals:!1,noUnusedParameters:!1,removeComments:!1,isolatedModules:!1},o=t.transpileModule(n,{compilerOptions:s,reportDiagnostics:!0}),r=o.diagnostics?.filter(c=>c.category===t.DiagnosticCategory.Error)||[],i=o.diagnostics?.filter(c=>c.category===t.DiagnosticCategory.Warning)||[];if(r.length>0)return{source:e,compiled:"",success:!1,error:Ze(r,t),diagnostics:r.map(c=>mt(c,t))};const a=o.outputText;return!a||a.trim().length===0?{source:e,compiled:"",success:!1,error:"Compilation produced empty output"}:{source:e,compiled:a,success:!0,diagnostics:i.map(c=>mt(c,t))}}catch(t){return{source:e,compiled:"",success:!1,error:t instanceof Error?t.message:"Unknown compilation error"}}}function Ze(e,t){return e.map(n=>mt(n,t)).join(`
`)}function mt(e,t){if(e.file&&e.start!==void 0){const{line:n,character:s}=e.file.getLineAndCharacterOfPosition(e.start),o=t.flattenDiagnosticMessageText(e.messageText,`
`);return`Line ${n+1}, Column ${s+1}: ${o}`}else return t.flattenDiagnosticMessageText(e.messageText,`
`)}function Qe(e){const t=[/\beval\s*\(/,/\bFunction\s*\(/,/\bsetTimeout\s*\(/,/\bsetInterval\s*\(/,/\bimportScripts\s*\(/,/\bfetch\s*\(/,/\bXMLHttpRequest\b/,/\bWebSocket\b/,/\blocation\b/,/\bwindow\b/,/\bnavigator\b/,/\blocalstorage\b/i,/\bsessionstorage\b/i,/\bindexeddb\b/i];let n=e;n=n.replace(/\bdocument\.createElement\s*\(\s*['"`]canvas['"`]\s*\)/g,"__ALLOWED_CANVAS_CREATE__").replace(/\bcanvas\.getContext\s*\(\s*['"`]2d['"`]\s*\)/g,"__ALLOWED_CANVAS_CONTEXT__");for(const o of t)if(o.test(n))return{isValid:!1,error:`Security violation: Code contains forbidden pattern: ${o.source}`};return e.split(`
`).length>1e3?{isValid:!1,error:"Code is too complex (exceeds 1000 lines)"}:{isValid:!0}}async function tn(e){try{const t=await ke(()=>import("./chunk-Dszta4ZM.js").then(c=>c.t),__vite__mapDeps([0,1,2,3,4,5]));if(!e.includes("renderMetadata"))return{source:e,compiled:"",success:!1,error:'Render formula must contain a "renderMetadata" function',diagnostics:['Missing required "renderMetadata" function']};const n=`
${e}

// Export the render function for execution
if (typeof renderMetadata === 'function') {
  self.renderMetadata = renderMetadata;
} else {
  throw new Error('renderMetadata function not found or not properly defined');
}
`,s={target:t.ScriptTarget.ES2020,module:t.ModuleKind.ESNext,lib:["ES2020","DOM"],strict:!0,noImplicitAny:!0,strictNullChecks:!0,strictFunctionTypes:!0,noImplicitReturns:!0,noUnusedLocals:!1,noUnusedParameters:!1,removeComments:!1,isolatedModules:!1},o=t.transpileModule(n,{compilerOptions:s,reportDiagnostics:!0}),r=o.diagnostics?.filter(c=>c.category===t.DiagnosticCategory.Error)||[],i=o.diagnostics?.filter(c=>c.category===t.DiagnosticCategory.Warning)||[];if(r.length>0)return{source:e,compiled:"",success:!1,error:Ze(r,t),diagnostics:r.map(c=>mt(c,t))};const a=o.outputText;return!a||a.trim().length===0?{source:e,compiled:"",success:!1,error:"Compilation produced empty output"}:{source:e,compiled:a,success:!0,diagnostics:i.map(c=>mt(c,t))}}catch(t){return{source:e,compiled:"",success:!1,error:t instanceof Error?t.message:"Unknown compilation error"}}}const to=Object.freeze(Object.defineProperty({__proto__:null,compileMetadataCanvasRenderer:tn,compileTypeScript:Hs,validateCompiledCode:Qe},Symbol.toStringTag,{value:"Module"}));async function Bs(e,t){const n=performance.now();try{let s=e.compiledRenderFormula;if(!s&&e.renderFormula){const i=await tn(e.renderFormula);if(!i.success)return{success:!1,error:i.error||"Compilation failed",executionTime:performance.now()-n};s=i.compiled}if(!s)return{success:!1,error:"No compiled render formula available",executionTime:performance.now()-n};const o=Qe(s);if(!o.isValid)return{success:!1,error:o.error||"Code validation failed",executionTime:performance.now()-n};const r=await Xs(s,t);return{success:!r.error,error:r.error,executionTime:performance.now()-n,renderedCanvas:r.canvas}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Unknown rendering error",executionTime:performance.now()-n}}}function Xs(e,t){return new Promise(n=>{try{const s=document.createElement("canvas");s.width=60,s.height=40;const o=s.getContext("2d");if(!o){n({error:"Could not create canvas context"});return}const r={...t,canvas:s,ctx:o},i=new Function("context","metadata","field","zone","zonePosition","gameState","canvas","ctx","cellWidth","cellHeight",`
        ${e}
        
        if (typeof renderMetadata === 'function') {
          return renderMetadata(context);
        } else {
          throw new Error('renderMetadata function not found');
        }
        `),a=setTimeout(()=>{n({error:"Metadata rendering timed out"})},1e3);try{i(r,r.metadata,r.field,r.zone,r.zonePosition,r.gameState,s,o,r.cellWidth,r.cellHeight),clearTimeout(a),n({canvas:s})}catch(c){clearTimeout(a),n({error:c instanceof Error?c.message:"Unknown error"})}}catch(s){n({error:s instanceof Error?s.message:"Execution error"})}})}async function Ys(e,t,n,s,o,r,i,a,c){if(!r.customMetadata)return;const l=a.filter(p=>p.renderOnCard&&p.renderFormula);if(l.length!==0)for(const p of l){const d={metadata:r.customMetadata,field:p,zone:r,zonePosition:i,gameState:c,canvas:document.createElement("canvas"),cellWidth:s,cellHeight:o};try{const f=await Bs(p,d);f.error?console.warn(`Error rendering metadata field ${p.name}:`,f.error):f.renderedCanvas&&e.drawImage(f.renderedCanvas,0,0,60,40,t,n,s,o)}catch(f){console.warn(`Error rendering metadata field ${p.name}:`,f)}}}function eo({gameState:e,onCardPlace:t,machine:n,width:s,height:o,containerRef:r}){const i=F.useRef(null),[a,c]=Ot.useState(null),[l,p]=Ot.useState(!1),[d,f]=Ot.useState(null),{transform:h,isDragging:m,dragStart:v,setDragging:T,setTransform:_,isPlacing:E,highlightedTiles:P}=pn(),R=n.selectors.selectedCard,ft=n.selectors.cardRotation||0,X=n.selectors.selectedVariations||[],J=n.actions,gt=(u,g)=>!e.board||e.board.length===0?!0:!e.board.some(w=>{const C=u<w.x+V&&u+V>w.x,b=g<w.y+q&&g+q>w.y;return C&&b}),A=60,j=40,V=2,q=2,vt=F.useCallback(()=>{if(s&&o)return{width:s,height:o};if(r?.current){const u=r.current.getBoundingClientRect();return{width:u.width,height:u.height}}return{width:window.innerWidth,height:window.innerHeight}},[s,o,r]),bt=F.useCallback(async()=>{const u=i.current;if(!u)return;const g=u.getContext("2d");if(!g)return;const w=vt();u.width=w.width,u.height=w.height,g.clearRect(0,0,u.width,u.height),g.save();const C=u.width/2,b=u.height/2;g.translate(C+h.offsetX,b+h.offsetY),g.scale(h.scale,h.scale),nn(g),e.board&&(on(g,e.board),rn(g,e.board),await an(g,e.board)),P&&P.length>0&&en(g,P),R&&a&&sn(g,R,a.x,a.y,ft),g.restore()},[e.board,h,R,a,ft,P,vt]);F.useEffect(()=>{bt()},[bt]),F.useEffect(()=>{const u=()=>{bt()};return window.addEventListener("resize",u),()=>window.removeEventListener("resize",u)},[bt]),F.useEffect(()=>{const u=g=>{g.key.toLowerCase()==="r"&&R&&!g.metaKey&&!g.altKey&&!g.ctrlKey&&(g.preventDefault(),J?.rotateCard(),console.log("Card rotated"))};return window.addEventListener("keydown",u),()=>window.removeEventListener("keydown",u)},[R,J]);const en=(u,g)=>{u.save();const w=[];e.board&&e.board.forEach(b=>{for(let x=0;x<q;x++)for(let S=0;S<V;S++)b.cells&&b.cells[x]&&b.cells[x][S]&&w.push({x:b.x+S,y:b.y+x})}),w.filter(b=>!g.some(x=>x.x===b.x&&x.y===b.y)).forEach(b=>{const x=b.x*A,S=b.y*j;u.fillStyle="rgba(0, 0, 0, 0.6)",u.fillRect(x,S,A,j)}),u.restore()},nn=u=>{u.strokeStyle="#374151",u.lineWidth=1/h.scale;const g=Math.ceil(30/h.scale);for(let w=-g;w<=g;w++){const C=w*A;u.beginPath(),u.moveTo(C,-g*j),u.lineTo(C,g*j),u.stroke()}for(let w=-g;w<=g;w++){const C=w*j;u.beginPath(),u.moveTo(-g*A,C),u.lineTo(g*A,C),u.stroke()}u.strokeStyle="#6b7280",u.lineWidth=2/h.scale,u.beginPath(),u.moveTo(0,-g*j),u.lineTo(0,g*j),u.stroke(),u.beginPath(),u.moveTo(-g*A,0),u.lineTo(g*A,0),u.stroke()},sn=(u,g,w,C,b=0)=>{const x=w*A,S=C*j,k=V*A,M=q*j,I=gt(w,C);if(u.globalAlpha=.8,u.save(),b!==0){const D=x+k/2,L=S+M/2;u.translate(D,L),u.rotate(b*Math.PI/180),u.translate(-D,-L)}u.fillStyle=I?"#ffffff":"#fee2e2",u.fillRect(x,S,k,M),u.strokeStyle=I?"#22c55e":"#dc2626",u.lineWidth=4/h.scale,u.strokeRect(x,S,k,M),I||(u.strokeStyle="#b91c1c",u.lineWidth=2/h.scale,u.strokeRect(x-2,S-2,k+4,M+4));for(let D=0;D<q;D++)for(let L=0;L<V;L++)if(g.cells&&g.cells[D]&&g.cells[D][L]){const ot=g.cells[D][L],xt=x+L*A,pt=S+D*j,Ct=ae(ot.type);u.fillStyle=Ct;const H=1/h.scale;u.fillRect(xt+H,pt+H,A-2*H,j-2*H),ot.roads&&ot.roads.length>0&&(u.lineWidth=A*.125,ot.roads.forEach(U=>{ce(u,xt,pt,A,j,U,void 0)}))}u.globalAlpha=1,u.restore()},on=(u,g)=>{const w=new Map;g.forEach(C=>{for(let b=0;b<q;b++)for(let x=0;x<V;x++)if(C.cells&&C.cells[b]&&C.cells[b][x]){const S=C.cells[b][x],k=`${C.x+x},${C.y+b}`;w.set(k,{type:S.type,roads:S.roads||[]})}}),u.save(),w.forEach((C,b)=>{const[x,S]=b.split(",").map(Number),k=x*A,M=S*j,I=ae(C.type);u.fillStyle=I,u.fillRect(k,M,A,j),u.strokeStyle="#000000",u.lineWidth=1/h.scale,u.strokeRect(k,M,A,j)}),u.restore()},rn=(u,g)=>{const w=new Map;g.forEach(C=>{for(let b=0;b<q;b++)for(let x=0;x<V;x++)if(C.cells&&C.cells[b]&&C.cells[b][x]){const S=C.cells[b][x],k=`${C.x+x},${C.y+b}`;w.set(k,{type:S.type,roads:S.roads||[]})}}),u.save(),w.forEach((C,b)=>{if(C.roads&&C.roads.length>0){const[x,S]=b.split(",").map(Number),k=x*A,M=S*j;u.lineWidth=A*.125,C.roads.forEach(I=>{ce(u,k,M,A,j,I,w)})}}),u.restore()},an=async(u,g)=>{let w=[];for(const b of X)if(b.metadataSchema?.fields){w=b.metadataSchema.fields;break}if(w.length===0)return;const C=new Map;g.forEach(b=>{for(let x=0;x<q;x++)for(let S=0;S<V;S++)if(b.cells&&b.cells[x]&&b.cells[x][S]){const k=b.cells[x][S],M=`${b.x+S},${b.y+x}`;C.set(M,{type:k.type,metadata:k.customMetadata,row:x,col:S,cell:k})}});for(const[b,x]of C.entries()){if(!x.metadata)continue;const[S,k]=b.split(",").map(Number),M=S*A,I=k*j;try{await Ys(u,M,I,A,j,x.cell,{row:x.row,col:x.col},w,e)}catch(D){console.warn(`Error rendering metadata for tile ${b}:`,D),cn(u,x.metadata,M,I,A)}}},cn=(u,g,w,C,b,x)=>{if(!g||Object.keys(g).length===0)return;u.save();const S=Math.max(2,b/20),k=w+b-S-2,M=C+S+2;u.fillStyle="#ff6b35",u.beginPath(),u.arc(k,M,S,0,2*Math.PI),u.fill();const I=Object.values(g)[0];I!=null&&I!==""&&(u.fillStyle="#333",u.font=`${Math.max(8,b/15)/h.scale}px Arial`,u.textAlign="left",u.fillText(String(I).slice(0,3),w+2,C+12)),u.restore()},ae=u=>{for(const g of X)if(g.zoneTypes){const w=g.zoneTypes.find(C=>C.id===u);if(w)return w.color}switch(u){case"residential":return"#3b82f6";case"commercial":return"#f97316";case"industrial":return"#6b7280";case"park":return"#22c55e";default:return"#e5e7eb"}},ce=(u,g,w,C,b,x,S)=>{const k=g+C/2,M=w+b/2;if(Array.isArray(x)&&x.length===2){const[I,D]=x,L=u.lineWidth,ot=Math.round(g/C),xt=Math.round(w/b),pt=H=>{if(!S)return!1;const U=[[0,-1],[1,0],[0,1],[-1,0]],[z,O]=U[H],wt=`${ot+z},${xt+O}`,tt=S.get(wt);if(!tt)return!1;const fn=(H+2)%4;return tt.roads.some(Dt=>Array.isArray(Dt)&&Dt.length===2?Dt.includes(fn):!1)},Ct=(H,U)=>{const z=U?0:L*.4;switch(H){case 0:return{x:k,y:w+z};case 1:return{x:g+C-z,y:M};case 2:return{x:k,y:w+b-z};case 3:return{x:g+z,y:M};default:return{x:k,y:M}}};if(I>=0&&I<4&&D>=0&&D<4){const H=pt(I),U=pt(D),z=Ct(I,H),O=Ct(D,U);u.save(),u.strokeStyle="#2d3748",u.lineWidth=L,u.lineJoin="round";const wt=I!==D;if(wt){const tt=Math.min(L*.8,Math.min(C,b)*.3);u.lineCap="butt",u.beginPath(),u.moveTo(z.x,z.y),u.arcTo(k,M,O.x,O.y,tt),u.lineTo(O.x,O.y),H||(u.lineCap="round",u.beginPath(),u.moveTo(z.x,z.y),u.lineTo(z.x,z.y),u.stroke(),u.lineCap="butt"),U||(u.lineCap="round",u.beginPath(),u.moveTo(O.x,O.y),u.lineTo(O.x,O.y),u.stroke(),u.lineCap="butt"),u.lineCap="butt",u.beginPath(),u.moveTo(z.x,z.y),u.arcTo(k,M,O.x,O.y,tt),u.lineTo(O.x,O.y),u.stroke()}else u.lineCap=H&&U?"butt":"round",H||(u.lineCap="round"),U||(u.lineCap="round"),u.beginPath(),u.moveTo(z.x,z.y),u.lineTo(O.x,O.y),u.stroke();if(u.strokeStyle="#fbbf24",u.lineWidth=L*.15,u.lineCap="butt",wt){u.setLineDash([L*.3,L*.2]);const tt=Math.min(L*.8,Math.min(C,b)*.3);u.beginPath(),u.moveTo(z.x,z.y),u.arcTo(k,M,O.x,O.y,tt),u.lineTo(O.x,O.y),u.stroke()}else u.setLineDash([]),u.beginPath(),u.moveTo(z.x,z.y),u.lineTo(O.x,O.y),u.stroke();u.setLineDash([]),u.restore()}}},ln=u=>{const g=R&&t;console.log("GameBoard: Mouse down, isPlacing:",E,"selectedCard:",!!R,"hasOnCardPlace:",!!t,"canPlace:",g),g&&(p(!0),f({x:u.clientX,y:u.clientY}),console.log("Started card drag")),T(!0,{x:u.clientX,y:u.clientY})},un=u=>{if(R){const g=i.current;if(!g)return;const w=g.getBoundingClientRect(),C=u.clientX-w.left,b=u.clientY-w.top,x=vt(),S=(C-x.width/2-h.offsetX)/h.scale,k=(b-x.height/2-h.offsetY)/h.scale,M=Math.round((S-V*A/2)/A),I=Math.round((k-q*j/2)/j);c({x:M,y:I})}else c(null);if(m&&v){const g=u.clientX-v.x,w=u.clientY-v.y;_({offsetX:h.offsetX+g,offsetY:h.offsetY+w}),T(!0,{x:u.clientX,y:u.clientY})}},dn=u=>{if(l&&d&&R&&t){if(Math.sqrt(Math.pow(u.clientX-d.x,2)+Math.pow(u.clientY-d.y,2))<5){console.log("Short click detected - placing card");const w=i.current;if(!w)return;const C=w.getBoundingClientRect(),b=u.clientX-C.left,x=u.clientY-C.top,S=vt(),k=(b-S.width/2-h.offsetX)/h.scale,M=(x-S.height/2-h.offsetY)/h.scale,I=Math.round((k-V*A/2)/A),D=Math.round((M-q*j/2)/j);console.log("Placing card at grid:",I,D),t(I,D)}else console.log("Long drag detected - not placing card");p(!1),f(null)}T(!1)};return F.useEffect(()=>{const u=i.current;if(!u)return;const g=w=>{w.preventDefault();const C=u.getBoundingClientRect(),b=w.deltaY>0?.9:1.1,x=Math.max(.1,Math.min(3,h.scale*b)),S=w.clientX-C.left-C.width/2,k=w.clientY-C.top-C.height/2,M=x/h.scale,I=h.offsetX-(S-h.offsetX)*(M-1),D=h.offsetY-(k-h.offsetY)*(M-1);_({scale:x,offsetX:I,offsetY:D})};return u.addEventListener("wheel",g,{passive:!1}),()=>{u.removeEventListener("wheel",g)}},[h,_]),G.jsx("canvas",{ref:i,className:"absolute inset-0",style:{cursor:R?"crosshair":m?"grabbing":"grab"},onMouseDown:ln,onMouseMove:un,onMouseUp:dn,onMouseLeave:()=>{p(!1),f(null),T(!1)}})}export{Ks as C,eo as G,Y as a,Ms as b,Js as c,Qs as d,tn as e,W as f,$ as g,gn as h,Ie as i,Cn as j,Tn as k,Us as l,wn as p,Jt as r,Zs as s,to as t};
