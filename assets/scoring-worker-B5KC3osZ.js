(function(){"use strict";function y(i,l,c){return{x:i.x+c,y:i.y+l}}function g(i){const l=new Map;return i.forEach((c,u)=>{for(let o=0;o<2;o++)for(let s=0;s<2;s++)if(c.cells&&c.cells[o]&&c.cells[o][s]){const e=c.cells[o][s],{x:r,y:a}=y(c,o,s),t=`${r},${a}`;l.set(t,{cardId:c.id,x:r,y:a,...e,cardIndex:u})}}),Array.from(l.values())}function x(i){const l=g(i),c=new Set,u=[];function o(e,r){return[{x:e-1,y:r},{x:e+1,y:r},{x:e,y:r-1},{x:e,y:r+1}]}function s(e,r){const a={type:r,tiles:[],size:0},t=[e];for(;t.length>0;){const n=t.pop(),f=`${n.x},${n.y}`;if(c.has(f))continue;c.add(f),a.tiles.push(n);const d=o(n.x,n.y);for(const m of d){const p=l.find(h=>h.x===m.x&&h.y===m.y),M=`${m.x},${m.y}`;p&&p.type===r&&!c.has(M)&&t.push(p)}}return a.size=a.tiles.length,a}for(const e of l){const r=`${e.x},${e.y}`;if(!c.has(r)){const a=s(e,e.type);u.push(a)}}return u}function T(i){const l=new Map;i.forEach((u,o)=>{for(let s=0;s<2;s++)for(let e=0;e<2;e++)if(u.cells&&u.cells[s]&&u.cells[s][e]){const{x:r,y:a}=y(u,s,e),t=`${r},${a}`;l.set(t,o)}});const c=[];return i.forEach((u,o)=>{for(let s=0;s<2;s++)for(let e=0;e<2;e++){const r=u.cells?.[s]?.[e];if(r&&r.roads&&r.roads.length>0){const{x:a,y:t}=y(u,s,e),n=`${a},${t}`;if(l.get(n)===o)for(const f of r.roads)c.push({cardId:u.id,cellRow:s,cellCol:e,x:a,y:t,segment:f})}}}),c}function w(i,l){const c=Math.abs(i.x-l.x),u=Math.abs(i.y-l.y);if(!(c===1&&u===0||c===0&&u===1))return!1;let o,s;c===1&&u===0?i.x<l.x?(o=1,s=3):(o=3,s=1):i.y<l.y?(o=2,s=0):(o=0,s=2);const e=i.segment[0]===o||i.segment[1]===o,r=l.segment[0]===s||l.segment[1]===s;return e&&r}function C(i){const l=T(i),c=new Set,u=[];function o(e){return`${e.cardId}-${e.cellRow}-${e.cellCol}-${e.segment[0]}-${e.segment[1]}`}function s(e){const r={segments:[],size:0},a=[e];for(;a.length>0;){const t=a.pop(),n=o(t);if(!c.has(n)){c.add(n),r.segments.push(t);for(const f of l){const d=o(f);!c.has(d)&&w(t,f)&&a.push(f)}}}return r.size=r.segments.length,r}for(const e of l){const r=o(e);if(!c.has(r)){const a=s(e);u.push(a)}}return u}function $(i,l){const c={sum:t=>t.reduce((n,f)=>n+f,0),max:t=>Math.max(...t),min:t=>Math.min(...t),count:(t,n)=>t.filter(n).length},u=x(i.board),o=C(i.board),s=g(i.board),e=(()=>{const t={};for(const n of s)t[n.y]||(t[n.y]={}),t[n.y][n.x]=n;return t})(),r={getAllTiles:()=>s,getTileAt:(t,n)=>e[t]?.[n]??null,getAdjacentTiles:(t,n)=>[{row:t-1,col:n},{row:t+1,col:n},{row:t,col:n-1},{row:t,col:n+1}].map(d=>e[d.row]?.[d.col]).filter(d=>d!==void 0),findClusters:(...t)=>{const n=Object.fromEntries(t.map(f=>[f,[]]));for(const f of u)n[f.type]&&n[f.type]?.push(f);return n},findLargestCluster:t=>u.reduce((n,f)=>f.type===t&&f.size>n.size?f:n,{type:"",size:0,tiles:[]}),countZonesOfType:t=>r.getAllTiles().filter(n=>n.type===t).length,findRoadNetworks:()=>o,getDistance:(t,n)=>{const f=t.x-n.x,d=t.y-n.y;return Math.sqrt(f*f+d*d)},isAdjacent:(t,n)=>{const f=Math.abs(t.x-n.x),d=Math.abs(t.y-n.y);return f===1&&d===0||f===0&&d===1},getTilesInRadius:(t,n)=>r.getAllTiles().filter(f=>r.getDistance(t,f)<=n)};return{gameState:JSON.parse(JSON.stringify(i)),...c,...r,roads:o,tileMap:e,tiles:s}}function A(i,l){const c=Object.keys(l);return new Function(...c,`
    'use strict';
    ${i}

    // Execute the user's calculateScore function
    return calculateScore({ ${c.join(", ")} });
  `)(...Object.keys(l).map(o=>l[o]))}const E=100;function S(i){return $(i)}function I(i,l){return new Promise((c,u)=>{const o=performance.now(),s=setTimeout(()=>{u(new Error("Formula execution timeout (100ms exceeded)"))},E);try{const e=S(l),r=self.importScripts;self.importScripts=void 0,self.fetch=void 0,self.XMLHttpRequest=void 0;try{const a=A(i,e),t=performance.now()-o;if(clearTimeout(s),typeof a!="number"||!isFinite(a)){u(new Error("Formula must return a finite number"));return}c({score:a,executionTime:t,highlightedTiles:[]})}finally{self.importScripts=r}}catch(e){clearTimeout(s),u(e)}})}self.onmessage=async function(i){const{id:l,formula:c,gameState:u}=i.data;try{const o=await I(c,u),s={id:l,result:o,error:void 0};self.postMessage(s)}catch(o){const s={id:l,result:void 0,error:o instanceof Error?o.message:"Unknown error"};self.postMessage(s)}}})();
